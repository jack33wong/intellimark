
> intellimark-chat-backend@1.0.0 dev
> cross-env NODE_OPTIONS=--no-deprecation nodemon --exec tsx --tsconfig tsconfig.dev.json server.ts

[33m[nodemon] 3.1.10[39m
[33m[nodemon] to restart at any time, enter `rs`[39m
[33m[nodemon] watching path(s): *.*[39m
[33m[nodemon] watching extensions: json,json[39m
[32m[nodemon] starting `tsx --tsconfig tsconfig.dev.json server.ts`[39m
‚ùå Session session-1758650074531-i6qfwtg6f not found in database
‚ùå LLM2 JSON parsing failed: Error: AI response missing annotations array
    at JsonUtils.cleanAndValidateJSON (/Users/ytwong/github/intellimark/backend/services/ai/JsonUtils.ts:23:13)
    at MarkingInstructionService.generateFromOCR (/Users/ytwong/github/intellimark/backend/services/ai/MarkingInstructionService.ts:112:17)
    at async LLMOrchestrator.executeMarking (/Users/ytwong/github/intellimark/backend/services/ai/LLMOrchestrator.ts:124:30)
    at async MarkHomeworkWithAnswer.generateMarkingInstructions (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:190:14)
    at async MarkHomeworkWithAnswer.run (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:347:33)
    at async <anonymous> (/Users/ytwong/github/intellimark/backend/routes/mark-homework.ts:428:20)
‚ùå New 2-step LLM flow failed: Error: LLM2 failed to generate valid marking annotations: AI response missing annotations array
    at MarkingInstructionService.generateFromOCR (/Users/ytwong/github/intellimark/backend/services/ai/MarkingInstructionService.ts:116:13)
    at async LLMOrchestrator.executeMarking (/Users/ytwong/github/intellimark/backend/services/ai/LLMOrchestrator.ts:124:30)
    at async MarkHomeworkWithAnswer.generateMarkingInstructions (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:190:14)
    at async MarkHomeworkWithAnswer.run (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:347:33)
    at async <anonymous> (/Users/ytwong/github/intellimark/backend/routes/mark-homework.ts:428:20)
‚ùå New 2-step LLM flow failed: Error: Gemini API request failed: 429 Too Many Requests
    at ModelProvider.makeGeminiTextRequest (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:55:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async ModelProvider.callGeminiText (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:7:22)
    at async OCRCleanupService.cleanOCRTextWithStepIds (/Users/ytwong/github/intellimark/backend/services/ai/OCRCleanupService.ts:76:19)
    at async LLMOrchestrator.executeMarking (/Users/ytwong/github/intellimark/backend/services/ai/LLMOrchestrator.ts:46:29)
    at async MarkHomeworkWithAnswer.generateMarkingInstructions (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:190:14)
    at async MarkHomeworkWithAnswer.run (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:347:33)
    at async <anonymous> (/Users/ytwong/github/intellimark/backend/routes/mark-homework.ts:428:20)
‚ùå New 2-step LLM flow failed: Error: Gemini API request failed: 429 Too Many Requests
    at ModelProvider.makeGeminiTextRequest (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:55:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async ModelProvider.callGeminiText (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:7:22)
    at async OCRCleanupService.cleanOCRTextWithStepIds (/Users/ytwong/github/intellimark/backend/services/ai/OCRCleanupService.ts:76:19)
    at async LLMOrchestrator.executeMarking (/Users/ytwong/github/intellimark/backend/services/ai/LLMOrchestrator.ts:46:29)
    at async MarkHomeworkWithAnswer.generateMarkingInstructions (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:190:14)
    at async MarkHomeworkWithAnswer.run (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:347:33)
    at async <anonymous> (/Users/ytwong/github/intellimark/backend/routes/mark-homework.ts:428:20)
‚ùå New 2-step LLM flow failed: Error: Gemini API request failed: 429 Too Many Requests
    at ModelProvider.makeGeminiTextRequest (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:55:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async ModelProvider.callGeminiText (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:7:22)
    at async OCRCleanupService.cleanOCRTextWithStepIds (/Users/ytwong/github/intellimark/backend/services/ai/OCRCleanupService.ts:76:19)
    at async LLMOrchestrator.executeMarking (/Users/ytwong/github/intellimark/backend/services/ai/LLMOrchestrator.ts:46:29)
    at async MarkHomeworkWithAnswer.generateMarkingInstructions (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:190:14)
    at async MarkHomeworkWithAnswer.run (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:347:33)
    at async <anonymous> (/Users/ytwong/github/intellimark/backend/routes/mark-homework.ts:428:20)
‚ùå New 2-step LLM flow failed: Error: Gemini API request failed: 429 Too Many Requests
    at ModelProvider.makeGeminiTextRequest (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:55:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async ModelProvider.callGeminiText (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:7:22)
    at async OCRCleanupService.cleanOCRTextWithStepIds (/Users/ytwong/github/intellimark/backend/services/ai/OCRCleanupService.ts:76:19)
    at async LLMOrchestrator.executeMarking (/Users/ytwong/github/intellimark/backend/services/ai/LLMOrchestrator.ts:46:29)
    at async MarkHomeworkWithAnswer.generateMarkingInstructions (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:190:14)
    at async MarkHomeworkWithAnswer.run (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:347:33)
    at async <anonymous> (/Users/ytwong/github/intellimark/backend/routes/mark-homework.ts:428:20)
‚ùå New 2-step LLM flow failed: Error: Gemini API request failed: 429 Too Many Requests
    at ModelProvider.makeGeminiTextRequest (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:55:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async ModelProvider.callGeminiText (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:7:22)
    at async OCRCleanupService.cleanOCRTextWithStepIds (/Users/ytwong/github/intellimark/backend/services/ai/OCRCleanupService.ts:76:19)
    at async LLMOrchestrator.executeMarking (/Users/ytwong/github/intellimark/backend/services/ai/LLMOrchestrator.ts:46:29)
    at async MarkHomeworkWithAnswer.generateMarkingInstructions (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:190:14)
    at async MarkHomeworkWithAnswer.run (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:347:33)
    at async <anonymous> (/Users/ytwong/github/intellimark/backend/routes/mark-homework.ts:428:20)
‚ùå New 2-step LLM flow failed: Error: Gemini API request failed: 429 Too Many Requests
    at ModelProvider.makeGeminiTextRequest (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:55:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async ModelProvider.callGeminiText (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:7:22)
    at async OCRCleanupService.cleanOCRTextWithStepIds (/Users/ytwong/github/intellimark/backend/services/ai/OCRCleanupService.ts:76:19)
    at async LLMOrchestrator.executeMarking (/Users/ytwong/github/intellimark/backend/services/ai/LLMOrchestrator.ts:46:29)
    at async MarkHomeworkWithAnswer.generateMarkingInstructions (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:190:14)
    at async MarkHomeworkWithAnswer.run (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:347:33)
    at async <anonymous> (/Users/ytwong/github/intellimark/backend/routes/mark-homework.ts:428:20)
‚ùå New 2-step LLM flow failed: Error: Gemini API request failed: 429 Too Many Requests
    at ModelProvider.makeGeminiTextRequest (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:55:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async ModelProvider.callGeminiText (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:7:22)
    at async OCRCleanupService.cleanOCRTextWithStepIds (/Users/ytwong/github/intellimark/backend/services/ai/OCRCleanupService.ts:76:19)
    at async LLMOrchestrator.executeMarking (/Users/ytwong/github/intellimark/backend/services/ai/LLMOrchestrator.ts:46:29)
    at async MarkHomeworkWithAnswer.generateMarkingInstructions (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:190:14)
    at async MarkHomeworkWithAnswer.run (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:347:33)
    at async <anonymous> (/Users/ytwong/github/intellimark/backend/routes/mark-homework.ts:428:20)
‚ùå New 2-step LLM flow failed: Error: Gemini API request failed: 429 Too Many Requests
    at ModelProvider.makeGeminiTextRequest (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:55:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async ModelProvider.callGeminiText (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:7:22)
    at async MarkingInstructionService.generateFromOCR (/Users/ytwong/github/intellimark/backend/services/ai/MarkingInstructionService.ts:100:19)
    at async LLMOrchestrator.executeMarking (/Users/ytwong/github/intellimark/backend/services/ai/LLMOrchestrator.ts:124:30)
    at async MarkHomeworkWithAnswer.generateMarkingInstructions (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:190:14)
    at async MarkHomeworkWithAnswer.run (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:347:33)
    at async <anonymous> (/Users/ytwong/github/intellimark/backend/routes/mark-homework.ts:428:20)
‚ùå New 2-step LLM flow failed: Error: Gemini API request failed: 429 Too Many Requests
    at ModelProvider.makeGeminiTextRequest (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:55:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async ModelProvider.callGeminiText (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:7:22)
    at async MarkingInstructionService.generateFromOCR (/Users/ytwong/github/intellimark/backend/services/ai/MarkingInstructionService.ts:100:19)
    at async LLMOrchestrator.executeMarking (/Users/ytwong/github/intellimark/backend/services/ai/LLMOrchestrator.ts:124:30)
    at async MarkHomeworkWithAnswer.generateMarkingInstructions (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:190:14)
    at async MarkHomeworkWithAnswer.run (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:347:33)
    at async <anonymous> (/Users/ytwong/github/intellimark/backend/routes/mark-homework.ts:428:20)
‚ùå New 2-step LLM flow failed: Error: Gemini API request failed: 429 Too Many Requests
    at ModelProvider.makeGeminiTextRequest (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:55:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async ModelProvider.callGeminiText (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:7:22)
    at async OCRCleanupService.cleanOCRTextWithStepIds (/Users/ytwong/github/intellimark/backend/services/ai/OCRCleanupService.ts:76:19)
    at async LLMOrchestrator.executeMarking (/Users/ytwong/github/intellimark/backend/services/ai/LLMOrchestrator.ts:46:29)
    at async MarkHomeworkWithAnswer.generateMarkingInstructions (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:190:14)
    at async MarkHomeworkWithAnswer.run (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:347:33)
    at async <anonymous> (/Users/ytwong/github/intellimark/backend/routes/mark-homework.ts:428:20)
‚ùå New 2-step LLM flow failed: Error: Gemini API request failed: 429 Too Many Requests
    at ModelProvider.makeGeminiTextRequest (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:55:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async ModelProvider.callGeminiText (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:7:22)
    at async OCRCleanupService.cleanOCRTextWithStepIds (/Users/ytwong/github/intellimark/backend/services/ai/OCRCleanupService.ts:76:19)
    at async LLMOrchestrator.executeMarking (/Users/ytwong/github/intellimark/backend/services/ai/LLMOrchestrator.ts:46:29)
    at async MarkHomeworkWithAnswer.generateMarkingInstructions (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:190:14)
    at async MarkHomeworkWithAnswer.run (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:347:33)
    at async <anonymous> (/Users/ytwong/github/intellimark/backend/routes/mark-homework.ts:428:20)
‚ùå New 2-step LLM flow failed: Error: Gemini API request failed: 429 Too Many Requests
    at ModelProvider.makeGeminiTextRequest (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:55:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async ModelProvider.callGeminiText (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:7:22)
    at async OCRCleanupService.cleanOCRTextWithStepIds (/Users/ytwong/github/intellimark/backend/services/ai/OCRCleanupService.ts:76:19)
    at async LLMOrchestrator.executeMarking (/Users/ytwong/github/intellimark/backend/services/ai/LLMOrchestrator.ts:46:29)
    at async MarkHomeworkWithAnswer.generateMarkingInstructions (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:190:14)
    at async MarkHomeworkWithAnswer.run (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:347:33)
    at async <anonymous> (/Users/ytwong/github/intellimark/backend/routes/mark-homework.ts:428:20)
‚ùå New 2-step LLM flow failed: Error: Gemini API request failed: 429 Too Many Requests
    at ModelProvider.makeGeminiTextRequest (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:55:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async ModelProvider.callGeminiText (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:7:22)
    at async OCRCleanupService.cleanOCRTextWithStepIds (/Users/ytwong/github/intellimark/backend/services/ai/OCRCleanupService.ts:76:19)
    at async LLMOrchestrator.executeMarking (/Users/ytwong/github/intellimark/backend/services/ai/LLMOrchestrator.ts:46:29)
    at async MarkHomeworkWithAnswer.generateMarkingInstructions (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:190:14)
    at async MarkHomeworkWithAnswer.run (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:347:33)
    at async <anonymous> (/Users/ytwong/github/intellimark/backend/routes/mark-homework.ts:428:20)
‚ùå New 2-step LLM flow failed: Error: Gemini API request failed: 429 Too Many Requests
    at ModelProvider.makeGeminiTextRequest (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:55:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async ModelProvider.callGeminiText (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:7:22)
    at async OCRCleanupService.cleanOCRTextWithStepIds (/Users/ytwong/github/intellimark/backend/services/ai/OCRCleanupService.ts:76:19)
    at async LLMOrchestrator.executeMarking (/Users/ytwong/github/intellimark/backend/services/ai/LLMOrchestrator.ts:46:29)
    at async MarkHomeworkWithAnswer.generateMarkingInstructions (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:190:14)
    at async MarkHomeworkWithAnswer.run (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:347:33)
    at async <anonymous> (/Users/ytwong/github/intellimark/backend/routes/mark-homework.ts:428:20)
‚ùå New 2-step LLM flow failed: Error: Gemini API request failed: 429 Too Many Requests
    at ModelProvider.makeGeminiTextRequest (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:55:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async ModelProvider.callGeminiText (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:7:22)
    at async OCRCleanupService.cleanOCRTextWithStepIds (/Users/ytwong/github/intellimark/backend/services/ai/OCRCleanupService.ts:76:19)
    at async LLMOrchestrator.executeMarking (/Users/ytwong/github/intellimark/backend/services/ai/LLMOrchestrator.ts:46:29)
    at async MarkHomeworkWithAnswer.generateMarkingInstructions (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:190:14)
    at async MarkHomeworkWithAnswer.run (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:347:33)
    at async <anonymous> (/Users/ytwong/github/intellimark/backend/routes/mark-homework.ts:428:20)
‚ùå New 2-step LLM flow failed: Error: Gemini API request failed: 429 Too Many Requests
    at ModelProvider.makeGeminiTextRequest (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:55:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async ModelProvider.callGeminiText (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:7:22)
    at async OCRCleanupService.cleanOCRTextWithStepIds (/Users/ytwong/github/intellimark/backend/services/ai/OCRCleanupService.ts:76:19)
    at async LLMOrchestrator.executeMarking (/Users/ytwong/github/intellimark/backend/services/ai/LLMOrchestrator.ts:46:29)
    at async MarkHomeworkWithAnswer.generateMarkingInstructions (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:190:14)
    at async MarkHomeworkWithAnswer.run (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:347:33)
    at async <anonymous> (/Users/ytwong/github/intellimark/backend/routes/mark-homework.ts:428:20)
‚ùå New 2-step LLM flow failed: Error: Gemini API request failed: 429 Too Many Requests
    at ModelProvider.makeGeminiTextRequest (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:55:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async ModelProvider.callGeminiText (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:7:22)
    at async MarkingInstructionService.generateFromOCR (/Users/ytwong/github/intellimark/backend/services/ai/MarkingInstructionService.ts:100:19)
    at async LLMOrchestrator.executeMarking (/Users/ytwong/github/intellimark/backend/services/ai/LLMOrchestrator.ts:124:30)
    at async MarkHomeworkWithAnswer.generateMarkingInstructions (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:190:14)
    at async MarkHomeworkWithAnswer.run (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:347:33)
    at async <anonymous> (/Users/ytwong/github/intellimark/backend/routes/mark-homework.ts:428:20)
‚ùå New 2-step LLM flow failed: Error: Gemini API request failed: 429 Too Many Requests
    at ModelProvider.makeGeminiTextRequest (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:55:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async ModelProvider.callGeminiText (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:7:22)
    at async MarkingInstructionService.generateFromOCR (/Users/ytwong/github/intellimark/backend/services/ai/MarkingInstructionService.ts:100:19)
    at async LLMOrchestrator.executeMarking (/Users/ytwong/github/intellimark/backend/services/ai/LLMOrchestrator.ts:124:30)
    at async MarkHomeworkWithAnswer.generateMarkingInstructions (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:190:14)
    at async MarkHomeworkWithAnswer.run (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:347:33)
    at async <anonymous> (/Users/ytwong/github/intellimark/backend/routes/mark-homework.ts:428:20)
‚ùå Session session-1758652498503-bl7gpnppn not found in database
‚ùå New 2-step LLM flow failed: Error: Gemini API request failed: 429 Too Many Requests
    at ModelProvider.makeGeminiTextRequest (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:55:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async ModelProvider.callGeminiText (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:7:22)
    at async MarkingInstructionService.generateFromOCR (/Users/ytwong/github/intellimark/backend/services/ai/MarkingInstructionService.ts:100:19)
    at async LLMOrchestrator.executeMarking (/Users/ytwong/github/intellimark/backend/services/ai/LLMOrchestrator.ts:124:30)
    at async MarkHomeworkWithAnswer.generateMarkingInstructions (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:190:14)
    at async MarkHomeworkWithAnswer.run (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:347:33)
    at async <anonymous> (/Users/ytwong/github/intellimark/backend/routes/mark-homework.ts:428:20)
‚ùå New 2-step LLM flow failed: Error: Gemini API request failed: 429 Too Many Requests
    at ModelProvider.makeGeminiTextRequest (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:55:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async ModelProvider.callGeminiText (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:7:22)
    at async MarkingInstructionService.generateFromOCR (/Users/ytwong/github/intellimark/backend/services/ai/MarkingInstructionService.ts:100:19)
    at async LLMOrchestrator.executeMarking (/Users/ytwong/github/intellimark/backend/services/ai/LLMOrchestrator.ts:124:30)
    at async MarkHomeworkWithAnswer.generateMarkingInstructions (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:190:14)
    at async MarkHomeworkWithAnswer.run (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:347:33)
    at async <anonymous> (/Users/ytwong/github/intellimark/backend/routes/mark-homework.ts:428:20)
‚ùå New 2-step LLM flow failed: Error: Gemini API request failed: 429 Too Many Requests
    at ModelProvider.makeGeminiTextRequest (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:55:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async ModelProvider.callGeminiText (/Users/ytwong/github/intellimark/backend/services/ai/ModelProvider.ts:7:22)
    at async MarkingInstructionService.generateFromOCR (/Users/ytwong/github/intellimark/backend/services/ai/MarkingInstructionService.ts:100:19)
    at async LLMOrchestrator.executeMarking (/Users/ytwong/github/intellimark/backend/services/ai/LLMOrchestrator.ts:124:30)
    at async MarkHomeworkWithAnswer.generateMarkingInstructions (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:190:14)
    at async MarkHomeworkWithAnswer.run (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:347:33)
    at async <anonymous> (/Users/ytwong/github/intellimark/backend/routes/mark-homework.ts:428:20)
‚ùå [2025-09-23T18:56:36.784Z] authenticateUser: All token verification methods failed
‚ùå [2025-09-23T18:56:36.784Z] ID token error: Firebase ID token has expired. Get a fresh ID token from your client app and try again (auth/id-token-expired). See https://firebase.google.com/docs/auth/admin/verify-id-tokens for details on how to retrieve an ID token.
‚ùå [2025-09-23T18:56:36.784Z] Custom token error: Firebase ID token has expired. Get a fresh ID token from your client app and try again (auth/id-token-expired). See https://firebase.google.com/docs/auth/admin/verify-id-tokens for details on how to retrieve an ID token.
‚ùå [2025-09-23T18:56:36.784Z] Parse error: Invalid custom token payload
‚ùå [2025-09-23T18:56:36.786Z] authenticateUser: All token verification methods failed
‚ùå [2025-09-23T18:56:36.786Z] ID token error: Firebase ID token has expired. Get a fresh ID token from your client app and try again (auth/id-token-expired). See https://firebase.google.com/docs/auth/admin/verify-id-tokens for details on how to retrieve an ID token.
‚ùå [2025-09-23T18:56:36.786Z] Custom token error: Firebase ID token has expired. Get a fresh ID token from your client app and try again (auth/id-token-expired). See https://firebase.google.com/docs/auth/admin/verify-id-tokens for details on how to retrieve an ID token.
‚ùå [2025-09-23T18:56:36.786Z] Parse error: Invalid custom token payload
‚ùå Gemini API Error: 429 Too Many Requests
‚ùå Error Details: {
  "error": {
    "code": 429,
    "message": "You exceeded your current quota. Please migrate to Gemini 2.0 Flash Preview (Image Generation) (models/gemini-2.0-flash-preview-image-generation) for higher quota limits. For more information on this error, head to: https://ai.google.dev/gemini-api/docs/rate-limits.",
    "status": "RESOURCE_EXHAUSTED",
    "details": [
      {
        "@type": "type.googleapis.com/google.rpc.QuotaFailure",
        "violations": [
          {
            "quotaMetric": "generativelanguage.googleapis.com/generate_requests_per_model_per_day",
            "quotaId": "GenerateRequestsPerDayPerProjectPerModel"
          }
        ]
      },
      {
        "@type": "type.googleapis.com/google.rpc.Help",
        "links": [
          {
            "description": "Learn more about Gemini API quotas",
            "url": "https://ai.google.dev/gemini-api/docs/rate-limits"
          }
        ]
      }
    ]
  }
}

‚ùå [CLASSIFICATION ERROR] Error: Gemini API request failed: 429 Too Many Requests - {
  "error": {
    "code": 429,
    "message": "You exceeded your current quota. Please migrate to Gemini 2.0 Flash Preview (Image Generation) (models/gemini-2.0-flash-preview-image-generation) for higher quota limits. For more information on this error, head to: https://ai.google.dev/gemini-api/docs/rate-limits.",
    "status": "RESOURCE_EXHAUSTED",
    "details": [
      {
        "@type": "type.googleapis.com/google.rpc.QuotaFailure",
        "violations": [
          {
            "quotaMetric": "generativelanguage.googleapis.com/generate_requests_per_model_per_day",
            "quotaId": "GenerateRequestsPerDayPerProjectPerModel"
          }
        ]
      },
      {
        "@type": "type.googleapis.com/google.rpc.Help",
        "links": [
          {
            "description": "Learn more about Gemini API quotas",
            "url": "https://ai.google.dev/gemini-api/docs/rate-limits"
          }
        ]
      }
    ]
  }
}

    at ClassificationService.makeGeminiRequest (/Users/ytwong/github/intellimark/backend/services/ai/ClassificationService.ts:127:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async ClassificationService.callGeminiForClassification (/Users/ytwong/github/intellimark/backend/services/ai/ClassificationService.ts:66:24)
    at async ClassificationService.classifyImage (/Users/ytwong/github/intellimark/backend/services/ai/ClassificationService.ts:39:16)
    at async MarkHomeworkWithAnswer.run (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:256:33)
    at async <anonymous> (/Users/ytwong/github/intellimark/backend/routes/mark-homework.ts:428:20)
‚ùå Gemini chat response failed: Error: Gemini API request failed: 429 Too Many Requests
    at AIMarkingService.makeGeminiChatRequest (/Users/ytwong/github/intellimark/backend/services/aiMarkingService.ts:395:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async AIMarkingService.callGeminiForChatResponse (/Users/ytwong/github/intellimark/backend/services/aiMarkingService.ts:325:24)
    at async AIMarkingService.generateChatResponse (/Users/ytwong/github/intellimark/backend/services/aiMarkingService.ts:182:16)
    at async MarkHomeworkWithAnswer.run (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:302:24)
    at async <anonymous> (/Users/ytwong/github/intellimark/backend/routes/mark-homework.ts:428:20)
‚ùå Chat response generation failed: Error: Gemini API request failed: 429 Too Many Requests
    at AIMarkingService.makeGeminiChatRequest (/Users/ytwong/github/intellimark/backend/services/aiMarkingService.ts:395:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async AIMarkingService.callGeminiForChatResponse (/Users/ytwong/github/intellimark/backend/services/aiMarkingService.ts:325:24)
    at async AIMarkingService.generateChatResponse (/Users/ytwong/github/intellimark/backend/services/aiMarkingService.ts:182:16)
    at async MarkHomeworkWithAnswer.run (/Users/ytwong/github/intellimark/backend/services/marking/MarkHomeworkWithAnswer.ts:302:24)
    at async <anonymous> (/Users/ytwong/github/intellimark/backend/routes/mark-homework.ts:428:20)
[31m[nodemon] app crashed - waiting for file changes before starting...[39m
