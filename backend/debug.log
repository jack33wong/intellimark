
> ai-marking-backend@1.0.0 dev
> cross-env NODE_OPTIONS=--no-deprecation nodemon --exec tsx --tsconfig tsconfig.dev.json server.ts

ğŸ‘¤ [PLAN CHECK] User 9mBfvniXTuMtQU8f0OnLhUK6aOv2 is on plan: ultra
ğŸ“¡ [MARKING] Processing POST /api/marking/process (hasRawBody: false)
ğŸš€ [MARKING] Controller started - Files: 1, Body Keys: model, aiMessageId
ğŸ” [CREDIT DEBUG] userId: 9mBfvniXTuMtQU8f0OnLhUK6aOv2, isAuthenticated: true
ğŸ’³ [CREDIT CHECK] Starting credit check for user: 9mBfvniXTuMtQU8f0OnLhUK6aOv2
ğŸ’³ [CREDIT CHECK] Estimated cost: 0.0486685, files: 1, bytes: 436685
ğŸ’³ [CREDIT CHECK] Result: {"canProceed":true,"remaining":548.53}

ğŸ”„ ========== UNIFIED PIPELINE START ==========
ğŸ”„ ============================================

[1m[32mâœ… [INPUT VALIDATION][0m [1mCOMPLETED[0m in [1m0.0s[0m ([32m[1mVALIDATION[0m)
[INPUT TYPE] Detected: Single Image (1 files)
[1m[32mâœ… [PREPROCESSING][0m [1mCOMPLETED[0m in [1m0.4s[0m ([32m[1mIMAGE-PROCESSING[0m)
[MAPPER] Using model: gemini-2.0-flash
[MAPPER] Starting Map Pass for 1 pages...
   ğŸ“¦ [MAPPER-BUCKET] Processing pages 0 to 0...

ğŸ” [MAPPER AUDIT] Batch of 1 images:
   âœ… Mapped Local[0] -> Global[0] | Content: 2a, 2b
âœ… [MAPPER] Map Pass complete in 2.61s. Mapped 1 pages.
[1m[32mâœ… [CLASSIFICATION][0m [1mCOMPLETED[0m in [1m7.3s[0m ([32m[1mGEMINI-2.0-FLASH[0m)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”€ [PERFECT SPLIT] Building standalone structures with re-indexing
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¯ [MODE ROUTING] Pure marking mode

âœ… Perfect split complete - each mode has consecutive 0-based indices
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

[1m[32mâœ… [CLASSIFICATION][0m [1mCOMPLETED[0m in [1m7.3s[0m ([32m[1mGEMINI-2.0-FLASH[0m)
ğŸ” [MODE DETECTION] Analysis (AFTER overrides):
  - All question-only: false
  - Has mixed content: false
  - Has any student work: true
  - Selected mode: Marking Mode
[1m[32mâœ… [OCR PROCESSING][0m [1mCOMPLETED[0m in [1m1.7s[0m ([32m[1mMATHPIX[0m)

ğŸ” [DETECTION CONTEXT]
   Strategy: Global Search
   Pool Size: 108 papers, 2709 total question candidates
------------------------------------------------------------------------------------------------------------------------------------

ğŸ“‹ [DETECTION AUDIT REPORT]
------------------------------------------------------------------------------------------------------------------------------------
| Q#   | Input Text (Fragment)                       | Match Result / Paper Title                         | Score | Status        |
------------------------------------------------------------------------------------------------------------------------------------
| 2ai  | Write 5.3 x 10' as an ordinary number.        | Edexcel GCSE 1MA1/3H June 2024 Q2                  | 0.865 | [32mâœ… SUCCESS[0m      |
| 2aii | Write 7.4 x 10 as an ordinary number.         | Edexcel GCSE 1MA1/3H June 2024 Q2                  | 0.865 | [32mâœ… SUCCESS[0m      |
| 2b   | Calculate the value of 9.7 x 10+ 2.45 Ã— 10... | Edexcel GCSE 1MA1/3H June 2024 Q2                  | 0.865 | [32mâœ… SUCCESS[0m      |
------------------------------------------------------------------------------------------------------------------------------------


ğŸ“Š [QUESTION DETECTION STATISTICS]
   Total questions: 3
   Detected: 3/3
   Not detected: 0
   [HINT] Hint Used: "Global Search"
   [HINT] Matched Papers: 108
[1m[32mâœ… [QUESTION DETECTION][0m [1mCOMPLETED[0m in [1m0.7s[0m ([32m[1mQUESTION-DETECTION[0m)

ğŸ”„ [RE-INDEXING] ğŸ›¡ï¸ Aligning physical pages...
   âš–ï¸ [PAGE-WEIGHT] Page 0: Weights=[2:2, 2ai:2.0101, 2aii:2.0101999999999998, 2b:2.02] -> Selected: 2.0101999999999998
ğŸ” [RE-INDEX DEBUG] Sorting Decision Matrix:
-----------------------------------------------------------------------------------------
| OrigIdx | Filename             | IsMeta | MinQ   | Detected Qs                        |
-----------------------------------------------------------------------------------------
| 0       | c38856a4-b989-41cc-8 | false  | 2.0101999999999998 | 2, 2ai, 2aii, 2b                   |
-----------------------------------------------------------------------------------------

ğŸš€ [SORT-RESULT] Final Logical Order:
-----------------------------------------------------------------------------------------
| Seq 0 | OrigIdx 0 | isMeta: false | minQ: 2.0101999999999998 |
-----------------------------------------------------------------------------------------
âœ… [RE-INDEXING] Completed. Pages have been straightened into Logical Order.
âœ… [RE-INDEXING] Deep Pointer Update Complete. Lines now point to new physical pages.

ğŸ”„ [OCR RE-ID] Regenerating Global Block IDs to match new Page Indices...
âœ… [OCR RE-ID] Completed. Blocks are now synchronized with physical pages.
âœ… [DIMENSIONS REBUILD] Map refreshed for 1 re-indexed pages.
[1m[32mâœ… [QUESTION DETECTION][0m [1mCOMPLETED[0m in [1m0.7s[0m ([32m[1mQUESTION-DETECTION[0m)
[1m[32mâœ… [QUESTION DETECTION][0m [1mCOMPLETED[0m in [1m0.7s[0m ([32m[1mQUESTION-DETECTION[0m)
ğŸ” [DIMENSIONS DEBUG] Pages: 1
ğŸ” [DIMENSIONS DEBUG] Map Size: 1
 âš–ï¸ [RECONCILE] Parent "2" was anchored at block index 8 (P0).
 âš–ï¸ [RECONCILE] SNAPPING "2" to match child "2ai" at block index 0 (P0).

ğŸ“¦ [ZONE-EVIDENCE] FINAL UPSTREAM ZONES:
   âœ… 2ai    | P0 | Y:  210 (6.0%) to  844 | X: 148 (Margin: 6.0%) | W: 2183
   âœ… 2aii   | P0 | Y:  844 (24.1%) to 1370 | X: 148 (Margin: 6.0%) | W: 2183
   âœ… 2b     | P0 | Y: 1370 (39.1%) to 3298 | X: 148 (Margin: 6.0%) | W: 2183
-------------------------------------------

[1m[32mğŸ”„ [AI MARKING][0m [1mSTARTING...[0m
 ğŸ•µï¸ [LINKER-INPUT-DEBUG-FINAL] p0_ocr_0 Content: "2 (a) (i) Write \( 5.3 \times 10^{4} \) as an ordinary number. [PRINTED_INSTRUCTION [Q2ai]]"
 ğŸ•µï¸ [LINKER-INPUT-DEBUG-FINAL] p0_ocr_0 Has Tag? true
 ğŸš« [VETO-REJECT] Candidate "(1)" matches Veto "write 53 x 10 as an ordinary number"
 ğŸš« [VETO-REJECT] Candidate "Give your answer in standard form." matches Veto "calculate the value of 97 x 10 245 10 give your answer in standard form"
 ğŸš« [VETO-REJECT] Candidate "(2)" matches Veto "calculate the value of 97 x 10 245 10 give your answer in standard form"
 ğŸš« [VETO-REJECT] Candidate "3" matches Veto "write 53 x 10 as an ordinary number"
 ğŸ§² [LINKER-RESCUE] 2b: Snapped UNMATCHED "3.42Ã—10" to Block p0_ocr_7
 ğŸš« [VETO-REJECT] Candidate "Give your answer in standard form." matches Veto "calculate the value of 97 x 10 245 10 give your answer in standard form"
 ğŸš« [VETO-REJECT] Candidate "(2)" matches Veto "calculate the value of 97 x 10 245 10 give your answer in standard form"
 ğŸš« [VETO-REJECT] Candidate "3" matches Veto "write 53 x 10 as an ordinary number"
 ğŸ§² [LINKER-RESCUE] 2b: Snapped UNMATCHED "3.42Ã—10" to Block p0_ocr_7
 ğŸ“ [PATH 3] Q2aii: Line "p0_q2_line_2" is UNMATCHED. Recovering position.
[1m[32mâœ… [AI MARKING][0m [1mCOMPLETED[0m in [1m5.4s[0m ([32m[1mGEMINI-2.0-FLASH[0m)
[1m[32mâœ… [MARKING][0m [1mCOMPLETED[0m in [1m5.4s[0m ([32m[1mAI-MARKING[0m)

ğŸ” [RESULT VERIFICATION] Checking what will be combined:
   ğŸ“Š Marking Results: 1 questions
   ğŸ“ Question Results: NO
   âœ… Both modes triggered: NO
[1m[32mâœ… [OUTPUT GENERATION][0m [1mCOMPLETED[0m in [1m1.9s[0m ([32m[1mOUTPUT-GENERATION[0m)
âš ï¸  [COMBINATION] No questionResponses found
[V2 CLEAN FIX] ğŸ—ï¸ Building UI Structure directly from 1 Engine Results...
[V2 CLEAN FIX] âœ… UI Structure ready (Strings preserved)
[1m[32mâœ… [PERFORMANCE SUMMARY AI][0m [1mCOMPLETED[0m in [1m0.9s[0m ([32m[1mGEMINI-2.0-FLASH[0m)
[V2 CLEAN FIX] ğŸ—ï¸ Building UI Structure directly from 1 Engine Results...
[V2 CLEAN FIX] âœ… UI Structure ready (Strings preserved)

ğŸ“Š [ANNOTATION SUMMARY]
-----------------------------------------------------------------------------------------
| Q#       | Score | Marks Awarded           | Match Status (AI -> Final)             |
|----------|-------|-------------------------|----------------------------------------|
| [32m2       [0m | 2/4   | B1, A0, M0, B1          | AI:1/4 â†’ M:3 S:0 U:1                   |
| [90m  ai    [0m | 1     | B1                      | AI:1/1 â†’ M:1 S:0 U:0                   |
| [90m  aii   [0m | 1     | B1                      | AI:0/1 â†’ M:0 S:0 U:1                   |
| [90m  b     [0m | 0     | A0, M0                  | AI:0/2 â†’ M:2 S:0 U:0                   |
|----------|-------|-------------------------|----------------------------------------|

=== PERFORMANCE SUMMARY ===
Total Processing Time: 19.4s
Model Used: gemini-2.0-flash
----------------------------
classification                      7.3s (38%)
marking                             5.4s (28%)
output_generation                   1.9s (10%)
ocr_processing                      1.7s (9%)
performance_summary                 0.9s (5%)
question_detection                  0.7s (3%)
preprocessing                       0.4s (2%)
database_persistence                0.2s (1%)
============================


ğŸ“Š [UsageTracker] Summary:
   Model: gemini-2.0-flash
   API Requests: 4 total
   Total Tokens: 18,971 (17,668 in + 1,303 out)
   Total Cost: $0.005833
   Mathpix OCR: 1 pages â†’ $0.004000

   Breakdown by Phase:
   â€¢ Mapper (Map Pass): 4,341 tokens (1 requests) â†’ $0.000455
   â€¢ Classification (Marking Pass): 6,709 tokens (1 requests) â†’ $0.000805
   â€¢ Marking: 7,336 tokens (1 requests) â†’ $0.000952
   â€¢ Performance Summary: 585 tokens (1 requests) â†’ $0.000075


ğŸ ========== UNIFIED PIPELINE END ==========
ğŸ ==========================================

âœ… [CONTROLLER] Pipeline completed, result exists: true, sessionId: sub-1770624404781
ğŸ’³ [CREDIT DEDUCT] Starting deduction for user: 9mBfvniXTuMtQU8f0OnLhUK6aOv2, sessionId: sub-1770624404781
ğŸ’³ [CREDIT DEDUCT] Incremental cost from tracker: 0.0058326
ğŸ” [SUBJECT EXTRACTION] examPapers[0].subject = "Mathematics"
ğŸ’³ Deducted 0.58 credits from user 9mBfvniXTuMtQU8f0OnLhUK6aOv2 (session: sub-1770624404781), remaining: 547.95
ğŸ’³ Deducted 0.0058 credits (session: sub-1770624404781) from user 9mBfvniXTuMtQU8f0OnLhUK6aOv2
âœ… [SUBJECT MARKING RESULT] Persisted marking result for subject: Mathematics, session: sub-1770624404781
