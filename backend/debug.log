
> ai-marking-backend@1.0.0 dev
> cross-env NODE_OPTIONS=--no-deprecation nodemon --exec tsx --tsconfig tsconfig.dev.json server.ts

âœ… Permissions configuration loaded from .env.local:
   - Analysis Plans: pro, ultra
   - Model Selection Plans: pro, ultra
âœ… Credit configuration loaded from .env.local (FAIL-FAST mode):
   - Conversion Rate: $0.01 per credit
   - Free Plan: 10 credits/month
   - Pro Plan: 200 credits/month
   - Ultra Plan: 600 credits/month
ğŸ’³ Stripe initialized in TEST mode
ğŸ“š Swagger UI available at /api-docs
ğŸ‘¤ [PLAN CHECK] User 9mBfvniXTuMtQU8f0OnLhUK6aOv2 is on plan: ultra
ğŸ“¡ [MARKING] Processing POST /api/marking/process (hasRawBody: false)
ğŸš€ [MARKING] Controller started - Files: 1, Body Keys: model, aiMessageId, customText
ğŸ” [CREDIT DEBUG] userId: 9mBfvniXTuMtQU8f0OnLhUK6aOv2, isAuthenticated: true
ğŸ’³ [CREDIT CHECK] Starting credit check for user: 9mBfvniXTuMtQU8f0OnLhUK6aOv2
ğŸ’³ [CREDIT CHECK] Estimated cost: 0.051697200000000006, files: 1, bytes: 466972
ğŸ’³ [CREDIT CHECK] Result: {"canProceed":true,"remaining":237.24}

ğŸ”„ ========== UNIFIED PIPELINE START ==========
ğŸ”„ ============================================

[1m[32mâœ… [INPUT VALIDATION][0m [1mCOMPLETED[0m in [1m0.0s[0m ([32m[1mVALIDATION[0m)
[INPUT TYPE] Detected: Single Image (1 files)
[1m[32mâœ… [PREPROCESSING][0m [1mCOMPLETED[0m in [1m0.2s[0m ([32m[1mIMAGE-PROCESSING[0m)
[MAPPER] Using model: gemini-2.0-flash
[MAPPER] Starting Map Pass for 1 pages...
   ğŸ“¦ [MAPPER-BUCKET] Processing pages 0 to 0...

ğŸ” [MAPPER AUDIT] Batch of 1 images:
   âœ… Mapped Local[0] -> Global[0] | Content: 5a, 5b, 5c
âœ… [MAPPER] Map Pass complete in 2.23s. Mapped 1 pages.
[1m[32mâœ… [CLASSIFICATION][0m [1mCOMPLETED[0m in [1m8.1s[0m ([32m[1mGEMINI-2.0-FLASH[0m)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”€ [PERFECT SPLIT] Building standalone structures with re-indexing
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¯ [MODE ROUTING] Pure marking mode

âœ… Perfect split complete - each mode has consecutive 0-based indices
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

[1m[32mâœ… [CLASSIFICATION][0m [1mCOMPLETED[0m in [1m8.1s[0m ([32m[1mGEMINI-2.0-FLASH[0m)
ğŸ” [MODE DETECTION] Analysis (AFTER overrides):
  - All question-only: false
  - Has mixed content: false
  - Has any student work: true
  - Selected mode: Marking Mode
[1m[32mâœ… [OCR PROCESSING][0m [1mCOMPLETED[0m in [1m3.4s[0m ([32m[1mMATHPIX[0m)

ğŸ” [DETECTION CONTEXT]
   Strategy: Pearson Edexcel Mathematics 1MA1/2H â€¢ June 2024 â€¢ Higher Tier
   Pool Size: 1 papers, 22 total question candidates
------------------------------------------------------------------------------------------------------------------------------------

ğŸ“‹ [DETECTION AUDIT REPORT]
------------------------------------------------------------------------------------------------------------------------------------
| Q#   | Input Text (Fragment)                       | Match Result / Paper Title                         | Score | Status        |
------------------------------------------------------------------------------------------------------------------------------------
| 5    | Complete the table of values for y = xÂ²-x     | Edexcel GCSE 1MA1/2H June 2024 Q5                  | 0.788 | [33mâš ï¸  RESCUED[0m    |
   â””â”€ Runners Up (Audit Trail):
      [32mâ—‹[0m [0.788] 1MA1/2H Q5                     | Txt:0.77 Num:0.53 Str:1.00 Sem:PASS
| 5a   | Complete the table of values for y = xÂ²-x ... | Edexcel GCSE 1MA1/2H June 2024 Q5                  | 0.788 | [33mâš ï¸  RESCUED[0m    |
   â””â”€ Runners Up (Audit Trail):
      [32mâ—‹[0m [0.788] 1MA1/2H Q5                     | Txt:0.77 Num:0.53 Str:1.00 Sem:PASS
| 5b   | Complete the table of values for y = xÂ²-x ... | Edexcel GCSE 1MA1/2H June 2024 Q5                  | 0.788 | [33mâš ï¸  RESCUED[0m    |
   â””â”€ Runners Up (Audit Trail):
      [32mâ—‹[0m [0.788] 1MA1/2H Q5                     | Txt:0.77 Num:0.53 Str:1.00 Sem:PASS
| 5c   | Complete the table of values for y = xÂ²-x ... | Edexcel GCSE 1MA1/2H June 2024 Q5                  | 0.788 | [33mâš ï¸  RESCUED[0m    |
   â””â”€ Runners Up (Audit Trail):
      [32mâ—‹[0m [0.788] 1MA1/2H Q5                     | Txt:0.77 Num:0.53 Str:1.00 Sem:PASS
------------------------------------------------------------------------------------------------------------------------------------


ğŸ“Š [QUESTION DETECTION STATISTICS]
   Total questions: 4
   Detected: 4/4
   Not detected: 0
   [HINT] Hint Used: "Pearson Edexcel Mathematics 1MA1/2H â€¢ June 2024 â€¢ Higher Tier"
   [HINT] Matched Papers: 1
[1m[32mâœ… [QUESTION DETECTION][0m [1mCOMPLETED[0m in [1m0.7s[0m ([32m[1mQUESTION-DETECTION[0m)

ğŸ”„ [RE-INDEXING] ğŸ›¡ï¸ Aligning physical pages...
   âš–ï¸ [PAGE-WEIGHT] Page 0: Weights=[5:5, 5a:5.01, 5b:5.02, 5c:5.03] -> Selected: 5.01
ğŸ” [RE-INDEX DEBUG] Sorting Decision Matrix:
-----------------------------------------------------------------------------------------
| OrigIdx | Filename             | IsMeta | MinQ   | Detected Qs                        |
-----------------------------------------------------------------------------------------
| 0       | new doc 2025-11-23 1 | false  | 5.01   | 5, 5a, 5b, 5c                      |
-----------------------------------------------------------------------------------------
âœ… [RE-INDEXING] Completed. Physical Page Index 0 is now: new doc 2025-11-23 11.51.11_6.jpg
âœ… [RE-INDEXING] Deep Pointer Update Complete. Lines now point to new physical pages.

ğŸ”„ [OCR RE-ID] Regenerating Global Block IDs to match new Page Indices...
âœ… [OCR RE-ID] Completed. Blocks are now synchronized with physical pages.
âœ… [DIMENSIONS REBUILD] Map refreshed for 1 re-indexed pages.
[1m[32mâœ… [QUESTION DETECTION][0m [1mCOMPLETED[0m in [1m0.7s[0m ([32m[1mQUESTION-DETECTION[0m)
[1m[32mâœ… [QUESTION DETECTION][0m [1mCOMPLETED[0m in [1m0.7s[0m ([32m[1mQUESTION-DETECTION[0m)
ğŸ” [DIMENSIONS DEBUG] Pages: 1
ğŸ” [DIMENSIONS DEBUG] Map Size: 1
[ZONE-TRUTH] Q5 Classifier Target: Page 0
[UPSTREAM-SORT] ğŸ† Fed 11 blocks in order: 0
[ZONE-DETECTOR] Deterministic Sort Order: 5 -> 5a -> 5b -> 5c
[ZONE-SORT] ğŸ† Physical Page Order: 0
 âš–ï¸ [ZONE-TIGHTEN] Pulling Q5a endY from 490 up to Q5b startY (340)
 âš–ï¸ [ZONE-TIGHTEN] Pulling Q5b endY from 1621 up to Q5c startY (1471)

ğŸ“¦ [ZONE-EVIDENCE] FINAL UPSTREAM ZONES:
   âœ… 5a     | P0 | Y:  143 (6.0%) to  340 | X: 98 (Margin: 6.0%) | W: 1448
   âœ… 5b     | P0 | Y:  340 (14.2%) to 1471 | X: 98 (Margin: 6.0%) | W: 1448
   âœ… 5c     | P0 | Y: 1471 (61.5%) to 2249 | X: 98 (Margin: 6.0%) | W: 1448
-------------------------------------------

[1m[32mğŸ”„ [AI MARKING][0m [1mSTARTING...[0m

ğŸ” [EXECUTOR PROBE] Q5
   - Task Page Index: 0
   - Visible Blocks Sample: p0_q5_line_1, p0_q5_line_2, p0_q5_line_3

ğŸš€ [PROMPT-ALIGNMENT] FINAL AI PROMPT SENT TO MODEL:
==================================================================
SYSTEM PROMPT: [REDACTED] (Set LOG_AI_MARKING_SYSTEM_PROMPT=true to enable)
------------------------------------------------------------------
USER PROMPT:
 
# MARKING TASK: Question 5

## QUESTION TEXT
**[5]**: Complete the table of values for $y=x^{2}-x$. [A table with x values -2, -1, 0, 1, 2, 3. y values 6, blank, 0, blank, 2, blank.] On the grid, draw the graph of $y=x^{2}-x$ for values of x from -2 to 3. [A coordinate grid is provided.] Use your graph to find estimates for the solutions of the equation $x^{2}-x=4$

**[5a]**: Complete the table of values for $y=x^{2}-x$. [A table with x values -2, -1, 0, 1, 2, 3. y values 6, blank, 0, blank, 2, blank.]

**[5b]**: On the grid, draw the graph of $y=x^{2}-x$ for values of x from -2 to 3. [A coordinate grid is provided.]

**[5c]**: Use your graph to find estimates for the solutions of the equation $x^{2}-x=4$




## MARKING SCHEME
> [INSTRUCTION]: You are the CHIEF EXAMINER.
> 1. **MATCH**: Match the student's work strictly to the M1/A1/B1 definitions below.
> 2. **STRICT SILO RULE (CRITICAL)**:
>    - You MUST respect the [MAX SCORE] for each sub-question.
>    - **OVERFLOW CHECK:** If you find 4 valid marks, but [6a] only allows 2, you MUST check if the other 2 marks belong to [6b].
>    - **DO NOT** lump all marks into the first bucket. Distribute them based on which sub-question they answer.

[OFFICIAL SCHEME]
[5a] [MAX SCORE: 2]
- B2: for all 3 values correct

[5b] [MAX SCORE: 2]
- B2: for a fully correct graph

[5c] [MAX SCORE: 2]
- M1: for drawing the line $y=4$ or reading off intersections where $y=4$ or one correct solution or both solutions given as coordinates, eg (-1.6, 2.6) or (-1.6, 4) and (2.6, 4)
- A1: for answers in the range -1.7 to -1.5 and 2.5 to 2.7 or ft their graph with at least 2 solutions


> [!IMPORTANT]
> The number of annotations you generate MUST BE EXACTLY EQUAL to the number of marks available in the MARKING SCHEME.
> - If the marking scheme has 4 potential marks (e.g., M1, M1, A1, B1), you MUST return exactly 4 annotations.
> - Do NOT omit marks that were not awarded; return them as 0 (e.g., M0, A0) to ensure the count matches exactly.


## STUDENT WORK (STRUCTURED)

[SUB-QUESTION a]
[ID: p0_q5_line_1] 2
[ID: p0_q5_line_2] 0
[ID: p0_q5_line_3] 0
[ID: p0_q5_line_4] 2
[ID: p0_q5_line_5] 6

[SUB-QUESTION b]
[ID: p0_visual_drawing_5_7] [DRAWING]

[SUB-QUESTION c]
[ID: p0_q5_line_7] -1.55, 2.6


 
## RAW OCR BLOCKS
Use these IDs to map the student's work. Match them yourself based on the Semantic Fidelity Rules.

[p0_ocr_0]: "5 (a) Complete the table of values for \( y=x^{2}-x \) [PRINTED_INSTRUCTION]"
[p0_ocr_1]: "\begin{tabular}{|c|c|c|c|c|c|c|} \hline\( x \) & -2 & -1 & 0 & 1 & 2 & 3"
[p0_ocr_2]: "\hline\( y \) & 6 & 2 & 0 & 0 & 2 & 6"
[p0_ocr_3]: "\hline \end{tabular}"
[p0_ocr_4]: "(2)"
[p0_ocr_5]: "(b) On the grid, draw the graph of \( y=x^{2}-x \) for values of \( x \) from -2 to 3"
[p0_ocr_6]: "(2)"
[p0_ocr_7]: "(c) Use your graph to find estimates for the solutions of the equation \( x^{2}-x=4 \)"
[p0_ocr_8]: "\( -1.55,2106 \)"
[p0_ocr_9]: "(2)"
[p0_ocr_10]: "6"

--------------------------------------------------
FINAL QUALITY CHECK (DO NOT IGNORE):
1. **PARTIAL MATCH TRAP:** Did you match a number like "36" to a digit like "3"? -> STOP. Return UNMATCHED.
2. **LABEL TRAP:** Did you anchor to a label like "(a)", "(ii)", or "Q1"? -> STOP. Return UNMATCHED.
3. **MISSING DATA:** If the exact whole number is not in the list, use "UNMATCHED".
--------------------------------------------------

==================================================================


========================================
[LOG-DEBUG] Raw AI MARKING JSON Response
----------------------------------------
```json
{
  "meta": {
    "question_total_marks": 6,
    "raw_correct_steps_found": 6,
    "steps_dropped_to_fit_budget": 0,
    "isTotalEstimated": false
  },
  "visualObservation": "The student has completed the table, drawn the graph and estimated the solutions.",
  "annotations": [
    {
      "action": "tick",
      "text": "B2",
      "line_id": "p0_q5_line_1",
      "content_desc": null,
      "ocr_match_status": "MATCHED",
      "linked_ocr_id": "p0_ocr_4",
      "reasoning": "The student has 2 correct values in the table (-1 = 2 and 3 = 6).",
      "subQuestion": "5a",
      "pageIndex": 0,
      "visual_position": null
    },
    {
      "action": "tick",
      "text": "B2",
      "line_id": "p0_visual_drawing_5_7",
      "content_desc": "Fully correct graph of y=x^2-x",
      "ocr_match_status": "VISUAL",
      "linked_ocr_id": null,
      "reasoning": "The student has drawn a fully correct graph of y=x^2-x.",
      "subQuestion": "5b",
      "pageIndex": 0,
      "visual_position": {
        "x": 50,
        "y": 50,
        "width": 40,
        "height": 40
      }
    },
    {
      "action": "tick",
      "text": "M1",
      "line_id": "p0_visual_drawing_5_7",
      "content_desc": "Drawing the line y=4",
      "ocr_match_status": "VISUAL",
      "linked_ocr_id": null,
      "reasoning": "The student has drawn the line y=4 on the graph.",
      "subQuestion": "5c",
      "pageIndex": 0,
      "visual_position": {
        "x": 55,
        "y": 55,
        "width": 40,
        "height": 40
      }
    },
    {
      "action": "tick",
      "text": "A1",
      "line_id": "p0_q5_line_7",
      "content_desc": null,
      "ocr_match_status": "MATCHED",
      "linked_ocr_id": "p0_ocr_8",
      "reasoning": "The student has provided answers in the range -1.7 to -1.5 and 2.5 to 2.7.",
      "subQuestion": "5c",
      "pageIndex": 0,
      "visual_position": null
    }
  ],
  "studentScore": {
    "totalMarks": 6,
    "awardedMarks": 6,
    "scoreText": "6/6"
  }
}
```
========================================

 âš–ï¸ [IRON-DOME-VETO] 5a: ID p0_ocr_4 is OUT OF ZONE.
 ğŸ“ [PATH 3] Q5a: Line "p0_q5_line_1" is UNMATCHED. Recovering position.
âœ… [IRON-DOME] Snapped mark to: p0_q5_line_7 (P0)
 âœ… [ZONE-OK] Q5c: Footprint at Y=72.0% is safe within 61.5-94.0%
 ğŸ›¡ï¸ [ZONE-PROTECT] Q5a: Footprint breach at Y=1.4%. Clamping to 8.0%
 ğŸ›¡ï¸ [ZONE-PROTECT] Q5b: Footprint breach at Y=11.5%. Clamping to 16.2%
 âœ… [ZONE-OK] Q5c: Footprint at Y=71.5% is safe within 61.5-94.0%
 ğŸ’ [BUDGET-CHECK] Q5c: Max Marks = 99. Items to Process: 2
 ğŸ’ [BUDGET-CHECK] Q5a: Max Marks = 99. Items to Process: 1
 ğŸ’ [BUDGET-CHECK] Q5b: Max Marks = 99. Items to Process: 1
âœ… [EXECUTOR] Finished Q5. Attached 3 labels. Q5 has 0 zones.
[1m[32mâœ… [AI MARKING][0m [1mCOMPLETED[0m in [1m6.7s[0m ([32m[1mGEMINI-2.0-FLASH[0m)
[1m[32mâœ… [MARKING][0m [1mCOMPLETED[0m in [1m6.7s[0m ([32m[1mAI-MARKING[0m)

ğŸ” [RESULT VERIFICATION] Checking what will be combined:
   ğŸ“Š Marking Results: 1 questions
   ğŸ“ Question Results: NO
   âœ… Both modes triggered: NO

ğŸ¨ [RENDERER AUDIT] Page 0 (Physical Index: 0) (W: 1644, H: 2392) - 1 Questions:
   âŒ Q5: NO SEMANTIC ZONE DATA for Page 0
   ğŸ” [OUTPUT-SERVICE] Page 0: Processing 1 marking results for zones...

âœ… [OUTPUT SERVICE] Final Page Order (Verified Content):
---------------------------------------------------------------------------------
| Seq | Index | Original Filename      | Content (Questions)                  |
---------------------------------------------------------------------------------
| [0] |  0    | new doc 2025-11-23 11. | 5a, 5b, 5c                           |
---------------------------------------------------------------------------------

[1m[32mâœ… [OUTPUT GENERATION][0m [1mCOMPLETED[0m in [1m1.7s[0m ([32m[1mOUTPUT-GENERATION[0m)
[V2 CLEAN FIX] ğŸ—ï¸ Building UI Structure directly from 1 Engine Results...
[V2 CLEAN FIX] âœ… UI Structure ready (Strings preserved)
[1m[32mâœ… [PERFORMANCE SUMMARY AI][0m [1mCOMPLETED[0m in [1m1.0s[0m ([32m[1mGEMINI-2.0-FLASH[0m)
[V2 CLEAN FIX] ğŸ—ï¸ Building UI Structure directly from 1 Engine Results...
[V2 CLEAN FIX] âœ… UI Structure ready (Strings preserved)

ğŸ“Š [ANNOTATION SUMMARY]
-----------------------------------------------------------------------------------------
| Q#       | Score | Marks Awarded           | Match Status (AI -> Final)             |
|----------|-------|-------------------------|----------------------------------------|
| [32m5       [0m | 6/6   | A1, M1, B2, B2          | AI:2/4 â†’ M:1 U:1                       |
| [90m  a     [0m | 2     | B2                      | AI:1/1 â†’ M:0 U:1                       |
| [90m  b     [0m | 2     | B2                      | AI:0/1 â†’ M:0 U:0                       |
| [90m  c     [0m | 2     | A1, M1                  | AI:1/2 â†’ M:1 U:0                       |
|----------|-------|-------------------------|----------------------------------------|

=== PERFORMANCE SUMMARY ===
Total Processing Time: 23.0s
Model Used: gemini-2.0-flash
----------------------------
classification                      8.1s (35%)
marking                             6.7s (29%)
ocr_processing                      3.4s (15%)
output_generation                   1.7s (8%)
performance_summary                 1.0s (4%)
question_detection                  0.7s (3%)
database_persistence                0.2s (1%)
preprocessing                       0.2s (1%)
============================


ğŸ“Š [UsageTracker] Summary:
   Model: gemini-2.0-flash
   API Requests: 4 total
   Total Tokens: 19,265 (17,683 in + 1,582 out)
   Total Cost: $0.005944
   Mathpix OCR: 1 pages â†’ $0.004000

   Breakdown by Phase:
   â€¢ Mapper (Map Pass): 4,346 tokens (1 requests) â†’ $0.000457
   â€¢ Classification (Marking Pass): 6,995 tokens (1 requests) â†’ $0.000910
   â€¢ Marking: 7,431 tokens (1 requests) â†’ $0.000971
   â€¢ Performance Summary: 493 tokens (1 requests) â†’ $0.000063


ğŸ ========== UNIFIED PIPELINE END ==========
ğŸ ==========================================

âœ… [CONTROLLER] Pipeline completed, result exists: true, sessionId: sub-1770060001415
ğŸ’³ [CREDIT DEDUCT] Starting deduction for user: 9mBfvniXTuMtQU8f0OnLhUK6aOv2, sessionId: sub-1770060001415
ğŸ’³ [CREDIT DEDUCT] Incremental cost from tracker: 0.0059437
ğŸ” [SUBJECT EXTRACTION] examPapers[0].subject = "Mathematics"
ğŸ’³ Deducted 0.59 credits from user 9mBfvniXTuMtQU8f0OnLhUK6aOv2 (session: sub-1770060001415), remaining: 236.65
ğŸ’³ Deducted 0.0059 credits (session: sub-1770060001415) from user 9mBfvniXTuMtQU8f0OnLhUK6aOv2
âœ… [SUBJECT MARKING RESULT] Persisted marking result for subject: Mathematics, session: sub-1770060001415
âœ… Permissions configuration loaded from .env.local:
   - Analysis Plans: pro, ultra
   - Model Selection Plans: pro, ultra
âœ… Credit configuration loaded from .env.local (FAIL-FAST mode):
   - Conversion Rate: $0.01 per credit
   - Free Plan: 10 credits/month
   - Pro Plan: 200 credits/month
   - Ultra Plan: 600 credits/month
ğŸ’³ Stripe initialized in TEST mode
ğŸ“š Swagger UI available at /api-docs
âœ… Permissions configuration loaded from .env.local:
   - Analysis Plans: pro, ultra
   - Model Selection Plans: pro, ultra
âœ… Credit configuration loaded from .env.local (FAIL-FAST mode):
   - Conversion Rate: $0.01 per credit
   - Free Plan: 10 credits/month
   - Pro Plan: 200 credits/month
   - Ultra Plan: 600 credits/month
ğŸ’³ Stripe initialized in TEST mode
ğŸ“š Swagger UI available at /api-docs
