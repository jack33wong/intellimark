
> ai-marking-backend@1.0.0 dev
> cross-env NODE_OPTIONS=--no-deprecation nodemon --exec tsx --tsconfig tsconfig.dev.json server.ts

‚úÖ Permissions configuration loaded from .env.local:
   - Analysis Plans: pro, ultra
   - Model Selection Plans: pro, ultra
‚úÖ Credit configuration loaded from .env.local (FAIL-FAST mode):
   - Conversion Rate: $0.01 per credit
   - Free Plan: 10 credits/month
   - Pro Plan: 200 credits/month
   - Ultra Plan: 600 credits/month
üí≥ Stripe initialized in TEST mode
üìö Swagger UI available at /api-docs
üë§ [PLAN CHECK] User 9mBfvniXTuMtQU8f0OnLhUK6aOv2 is on plan: ultra
üì° [MARKING] Processing POST /api/marking/process (hasRawBody: false)
üöÄ [MARKING] Controller started - Files: 1, Body Keys: model, aiMessageId
üîç [CREDIT DEBUG] userId: 9mBfvniXTuMtQU8f0OnLhUK6aOv2, isAuthenticated: true
üí≥ [CREDIT CHECK] Starting credit check for user: 9mBfvniXTuMtQU8f0OnLhUK6aOv2
üí≥ [CREDIT CHECK] Estimated cost: 0.0449631, files: 1, bytes: 399631
üí≥ [CREDIT CHECK] Result: {"canProceed":true,"remaining":426.86}

üîÑ ========== UNIFIED PIPELINE START ==========
üîÑ ============================================

[1m[32m‚úÖ [INPUT VALIDATION][0m [1mCOMPLETED[0m in [1m0.0s[0m ([32m[1mVALIDATION[0m)
[INPUT TYPE] Detected: Single Image (1 files)
[1m[32m‚úÖ [PREPROCESSING][0m [1mCOMPLETED[0m in [1m0.4s[0m ([32m[1mIMAGE-PROCESSING[0m)
[MAPPER] Using model: gemini-2.0-flash
[MAPPER] Starting Map Pass for 1 pages...
‚úÖ [MAPPER] Map Pass complete in 2.22s. Mapped 1 pages.
[1m[32m‚úÖ [CLASSIFICATION][0m [1mCOMPLETED[0m in [1m8.4s[0m ([32m[1mGEMINI-2.0-FLASH[0m)

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üîÄ [PERFECT SPLIT] Building standalone structures with re-indexing
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üéØ [MODE ROUTING] Pure marking mode

‚úÖ Perfect split complete - each mode has consecutive 0-based indices
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

[1m[32m‚úÖ [CLASSIFICATION][0m [1mCOMPLETED[0m in [1m8.4s[0m ([32m[1mGEMINI-2.0-FLASH[0m)
üîç [MODE DETECTION] Analysis (AFTER overrides):
  - All question-only: false
  - Has mixed content: false
  - Has any student work: true
  - Selected mode: Marking Mode
[1m[32m‚úÖ [OCR PROCESSING][0m [1mCOMPLETED[0m in [1m2.4s[0m ([32m[1mMATHPIX[0m)
[1m[32m‚úÖ [QUESTION DETECTION][0m [1mCOMPLETED[0m in [1m0.7s[0m ([32m[1mQUESTION-DETECTION[0m)

üîç [DETECTION CONTEXT]
   Strategy: Global Search
   Pool Size: 108 papers, 2709 total question candidates
------------------------------------------------------------------------------------------------------------------------------------

üìã [DETECTION AUDIT REPORT]
------------------------------------------------------------------------------------------------------------------------------------
| Q#   | Input Text (Fragment)                       | Match Result / Paper Title                         | Score | Status        |
------------------------------------------------------------------------------------------------------------------------------------
| 6    | Tim has two biased coins, coin A and coin ... | Edexcel GCSE 1MA1/3H June 2024 Q6                  | 0.891 | [32m‚úÖ SUCCESS[0m      |
| 6a   | Tim has two biased coins, coin A and coin ... | Edexcel GCSE 1MA1/3H June 2024 Q6                  | 0.891 | [32m‚úÖ SUCCESS[0m      |
| 6b   | Tim has two biased coins, coin A and coin ... | Edexcel GCSE 1MA1/3H June 2024 Q6                  | 0.891 | [32m‚úÖ SUCCESS[0m      |
------------------------------------------------------------------------------------------------------------------------------------


üìä [QUESTION DETECTION STATISTICS]
   Total questions: 3
   Detected: 3/3
   Not detected: 0
   [HINT] Hint Used: "Global Search"
   [HINT] Matched Papers: 108
[DRAWING] Q6: Passing image to Marking AI (Drawing Classification returned 0 for this drawing question)
[DRAWING] Q6: Will pass image to Marking AI
‚úÖ createMarkingTasksFromClassification completed, created 1 marking task(s)
[1m[32müîÑ [AI MARKING][0m [1mSTARTING...[0m

üîç [MAPPING DEBUG] Available Classification Targets for Q6:
   [0] ID: line_1 | Text: "0.4" | Handwriting: true | Box: [79,154,12,14]
   [1] ID: line_2 | Text: "0.55" | Handwriting: true | Box: [121,140,17,14]
   [2] ID: line_3 | Text: "0.45" | Handwriting: true | Box: [121,186,17,14]
   [3] ID: line_4 | Text: "0.55" | Handwriting: true | Box: [121,140,17,14]
   [4] ID: line_5 | Text: "0.45" | Handwriting: true | Box: [121,186,17,14]
   [5] ID: line_6 | Text: "0.33" | Handwriting: true | Box: [171,267,17,18]
üîç [ZONE SCAN] Scanning blocks for landmarks...
   üìç Found Landmark: "a" at Page 0, Y=573
   üìç Found Landmark: "b" at Page 0, Y=2083

üîç [ZONE DEBUG] Detected Semantic Zones: a, b

üîç [COORD-DEBUG] Inspecting Potential Offset Sources...
   üëâ QuestionDetection Box: undefined
   ‚ö†Ô∏è ClassificationBlocks array is empty.
   [ANCHOR-FIX] Bridging Root Question '6' to First Child Landmark 'a' at Y=573
   üîç [COORD-DEBUG] Using Landmark Anchor [a] for Offset: x=351, y=573
[BUDGET Q6] ü•á Trusting AI Total: 4 (Reason: Explicit Read)
ü§ñ [AI RESPONSE] [31mQ6[0m - Clean response received:
  - Annotations count: [35m2[0m
  - Student score: [32m4/4[0m
  - Usage tokens: [33m7192[0m
     [36mThe student has completed the probability tree diagram and calculated the probability of both coins landing on heads.[0m
  - Annotations:
    1. [32mtick[0m [34m[block_0_4][0m [B1 B1] [34m"0.4"[0m
      ‚Ü≥ Reason: Correct probability (0.4) for coin A not landing on heads. | Correct probabilities (0.55, 0.45, 0.55, 0.45) for coin B.
      ‚Ü≥ OCR Match: [35m"0.4"[0m
      ‚Ü≥ Classification: [35m"0.4"[0m
      ‚Ü≥ Status: [32m"MATCHED"[0m
    2. [32mtick[0m [34m[block_0_7][0m [M1 A1] [34m"0.33"[0m
      ‚Ü≥ Reason: Correct method for calculating the probability of both coins landing on heads (0.6 * 0.55). | Correct probability of both coins landing on heads (0.33).
      ‚Ü≥ OCR Match: [35m"0.33"[0m
      ‚Ü≥ Classification: [35m"0.33"[0m
      ‚Ü≥ Status: [32m"MATCHED"[0m
   üõ°Ô∏è [REDIRECT] Intercepted link to Instruction [block_0_4]
   üõ°Ô∏è [REDIRECT] Intercepted link to Instruction [block_0_7]

üîç [ANNOTATION-AUDIT] Phase 1: ID Correction for Q6

üîç [ENRICH-START] Processing Q6 | 2 annotations
   ‚öì [GLOBAL-OFFSET] Applying offsets: x=351, y=573

üëâ [ANNO 0] "B1 B1" (ID: ) | Status In: VISUAL
   ‚ÑπÔ∏è [PATH: PRECOMPUTED] Preserve pixel scale: 121, 140
   ‚öñÔ∏è [SCOPED-OFFSET] Annotation "B1 B1" uses Landmark [a] (+351, +573)
   üèóÔ∏è [OFFSET] Applying Anchor (+351, +573)
      Final Coord: (472, 713)

üëâ [ANNO 1] "M1 A1" (ID: ) | Status In: VISUAL
   ‚ÑπÔ∏è [PATH: PRECOMPUTED] Preserve pixel scale: 1787, 2439
   ‚öñÔ∏è [SCOPED-OFFSET] Annotation "M1 A1" uses Landmark [b] (+354, +2083)
   üèóÔ∏è [OFFSET] Applying Anchor (+354, +2083)
      Final Coord: (2141, 4522)

üîç [ANNOTATION-AUDIT] Phase 3: Spatial Sanitization for Q6
‚úÖ [ANNOTATION-AUDIT] Complete

[SCORE DEBUG] Q6: rawScore={"totalMarks":4,"awardedMarks":4,"scoreText":"4/4"}, parsedAwarded=4, parsedTotal=4, schemeTotal=4
[GUILLOTINE CHECK] Q6: isGeneric=false, hasAnnotations=true, hasScore=true, SchemeTotal=4, ResultTotal=4
[1m[32m‚úÖ [AI MARKING][0m [1mCOMPLETED[0m in [1m7.2s[0m ([32m[1mGEMINI-2.0-FLASH[0m)
[1m[32m‚úÖ [MARKING][0m [1mCOMPLETED[0m in [1m7.2s[0m ([32m[1mAI-MARKING[0m)

üîç [RESULT VERIFICATION] Checking what will be combined:
   üìä Marking Results: 1 questions
   üìù Question Results: NO
   ‚úÖ Both modes triggered: NO
[TOTAL TRAP] Q6: Scheme=4, AI=4, IsDefault=false -> FINAL=4
[TOTAL TRAP] Grand Total Possible Score: 4
[32müîÑ [LOGICAL RE-INDEXING] Aligning logical indices with sorted physical order...[0m
[32m‚úÖ [LOGICAL RE-INDEXING] Re-indexed 1 questions and 1 pages.[0m
[32m‚úÖ [1m[FINAL PAGE ORDER][0m [32m[1] Page 6 ([37mQ6a, Q6b[32m)[0m
[1m[32m‚úÖ [OUTPUT GENERATION][0m [1mCOMPLETED[0m in [1m2.0s[0m ([32m[1mOUTPUT-GENERATION[0m)
[SYNC FIX] üîÑ Synchronizing UI Structure (Schema Defaults) with Engine Results (Actuals)...
[SYNC FIX] ‚úÖ Q6: Updated Total Available Marks from undefined (Schema) -> 4 (Engine)
[SYNC FIX] üèÅ Updated Grand Total from 12 -> 4
[1m[32m‚úÖ [PERFORMANCE SUMMARY AI][0m [1mCOMPLETED[0m in [1m0.8s[0m ([32m[1mGEMINI-2.0-FLASH[0m)

üìä [ANNOTATION SUMMARY]
----------------------------------------------------------------------
| Q#       | Score | Marks Awarded           | Match Status              |
|----------|-------|-------------------------|---------------------------|
| [32m6       [0m | 4/4   | B1, B1, M1, A1          | M:0 V:4 U:0 S:0           |
| [90m  a     [0m | 2     | B1, B1                  | M:0 V:2 U:0 S:0           |
| [90m  b     [0m | 2     | M1, A1                  | M:0 V:2 U:0 S:0           |
|----------|-------|-------------------------|---------------------------|

=== PERFORMANCE SUMMARY ===
Total Processing Time: 22.9s
Model Used: gemini-2.0-flash
----------------------------
classification                      8.4s (37%)
marking                             7.2s (31%)
ocr_processing                      2.4s (10%)
output_generation                   2.0s (9%)
performance_summary                 0.8s (4%)
question_detection                  0.7s (3%)
preprocessing                       0.4s (2%)
database_persistence                0.2s (1%)
============================


üìä [UsageTracker] Summary:
   Model: gemini-2.0-flash
   API Requests: 3 total
   Total Tokens: 11,692 (10,905 in + 787 out)
   Total Cost: $0.004973
   Mathpix OCR: 1 pages ‚Üí $0.004000

   Breakdown by Phase:
   ‚Ä¢ Mapper (Map Pass): 4,161 tokens (1 requests) ‚Üí $0.000432
   ‚Ä¢ Classification (Marking Pass): 6,988 tokens (1 requests) ‚Üí $0.000910
   ‚Ä¢ Performance Summary: 543 tokens (1 requests) ‚Üí $0.000064


üèÅ ========== UNIFIED PIPELINE END ==========
üèÅ ==========================================

‚úÖ [CONTROLLER] Pipeline completed, result exists: true, sessionId: sub-1768927164595
üí≥ [CREDIT DEDUCT] Starting deduction for user: 9mBfvniXTuMtQU8f0OnLhUK6aOv2, sessionId: sub-1768927164595
üí≥ [CREDIT DEDUCT] Incremental cost from tracker: 0.0049733
üîç [SUBJECT EXTRACTION] examPapers[0].subject = "Mathematics"
üí≥ Deducted 0.50 credits from user 9mBfvniXTuMtQU8f0OnLhUK6aOv2 (session: sub-1768927164595), remaining: 426.36
üí≥ Deducted 0.0050 credits (session: sub-1768927164595) from user 9mBfvniXTuMtQU8f0OnLhUK6aOv2
‚úÖ [SUBJECT MARKING RESULT] Persisted marking result for subject: Mathematics, session: sub-1768927164595
