
> ai-marking-backend@1.0.0 dev
> cross-env NODE_OPTIONS=--no-deprecation nodemon --exec tsx --tsconfig tsconfig.dev.json server.ts

âœ… Permissions configuration loaded from .env.local:
   - Analysis Plans: pro, ultra
   - Model Selection Plans: pro, ultra
âœ… Credit configuration loaded from .env.local (FAIL-FAST mode):
   - Conversion Rate: $0.01 per credit
   - Free Plan: 10 credits/month
   - Pro Plan: 200 credits/month
   - Ultra Plan: 600 credits/month
ðŸ’³ Stripe initialized in TEST mode
ðŸ“š Swagger UI available at /api-docs
ðŸ‘¤ [PLAN CHECK] User 9mBfvniXTuMtQU8f0OnLhUK6aOv2 is on plan: ultra
ðŸ“¡ [MARKING] Processing POST /api/marking/process (hasRawBody: false)
ðŸš€ [MARKING] Controller started - Files: 1, Body Keys: model, aiMessageId
ðŸ” [CREDIT DEBUG] userId: 9mBfvniXTuMtQU8f0OnLhUK6aOv2, isAuthenticated: true
ðŸ’³ [CREDIT CHECK] Starting credit check for user: 9mBfvniXTuMtQU8f0OnLhUK6aOv2
ðŸ’³ [CREDIT CHECK] Estimated cost: 0.0916627, files: 1, bytes: 866627
ðŸ’³ [CREDIT CHECK] Result: {"canProceed":true,"remaining":329.85}

ðŸ”„ ========== UNIFIED PIPELINE START ==========
ðŸ”„ ============================================

[1m[32mâœ… [INPUT VALIDATION][0m [1mCOMPLETED[0m in [1m0.0s[0m ([32m[1mVALIDATION[0m)
[INPUT TYPE] Detected: Single Image (1 files)
[1m[32mâœ… [PREPROCESSING][0m [1mCOMPLETED[0m in [1m0.2s[0m ([32m[1mIMAGE-PROCESSING[0m)
[MAPPER] Using model: gemini-2.0-flash
[MAPPER] Starting Map Pass for 1 pages...
âœ… [MAPPER] Map Pass complete in 1.61s. Mapped 1 pages.
[1m[32mâœ… [CLASSIFICATION][0m [1mCOMPLETED[0m in [1m7.8s[0m ([32m[1mGEMINI-2.0-FLASH[0m)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ðŸ”€ [PERFECT SPLIT] Building standalone structures with re-indexing
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ðŸŽ¯ [MODE ROUTING] Pure marking mode

âœ… Perfect split complete - each mode has consecutive 0-based indices
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

[1m[32mâœ… [CLASSIFICATION][0m [1mCOMPLETED[0m in [1m7.8s[0m ([32m[1mGEMINI-2.0-FLASH[0m)
ðŸ” [MODE DETECTION] Analysis (AFTER overrides):
  - All question-only: false
  - Has mixed content: false
  - Has any student work: true
  - Selected mode: Marking Mode
[1m[32mâœ… [OCR PROCESSING][0m [1mCOMPLETED[0m in [1m3.7s[0m ([32m[1mMATHPIX[0m)
[SIMILARITY OVERRIDE] 98% because MatchRate=1.00 in Keys=[kasim,some,small,jars,medium,large,fraction,empty,number,percentage,kasims]
   âœ… Matched Part: 7 (11 marks)
   ðŸ“Š Final Map Keys: 7
[1m[32mâœ… [QUESTION DETECTION][0m [1mCOMPLETED[0m in [1m1.0s[0m ([32m[1mQUESTION-DETECTION[0m)

ðŸ” [DETECTION CONTEXT]
   Strategy: Global Search
   Pool Size: 108 papers, 2709 total question candidates
------------------------------------------------------------------------------------------------------------------------------------

ðŸ“‹ [DETECTION AUDIT REPORT]
------------------------------------------------------------------------------------------------------------------------------------
| Q#   | Input Text (Fragment)                       | Match Result / Paper Title                         | Score | Status        |
------------------------------------------------------------------------------------------------------------------------------------
| 7    | Kasim has some small jars, some medium jar... | Edexcel GCSE 1MA1/1H June 2024 Q7                  | 0.899 | [32mâœ… SUCCESS[0m      |
------------------------------------------------------------------------------------------------------------------------------------


ðŸ“Š [QUESTION DETECTION STATISTICS]
   Total questions: 1
   Detected: 1/1
   Not detected: 0
   [HINT] Hint Used: "Global Search"
   [HINT] Matched Papers: 108
ðŸ” [MERGE-DEBUG] attempting to merge classification results into 1 pages
   âœ… [MERGE-DEBUG] Page 0 merged with 1 results (Total Qs: 1)
ðŸ†” [GLOBAL-ID] Assigning stable IDs to all OCR blocks before task creation...
âœ… createMarkingTasksFromClassification completed, created 1 marking task(s)
[1m[32mðŸ”„ [AI MARKING][0m [1mSTARTING...[0m
   ðŸ¤– [ZONE-STRATEGY] Generic Loop. Using 1 Classification-derived zones.

ðŸš€ [PROMPT-ALIGNMENT] FINAL AI PROMPT SENT TO MODEL:
==================================================================
SYSTEM PROMPT:
 You are an AI assistant that marks student work. Your task is to generate a single, valid JSON object.

---

## 1. THE PRIME DIRECTIVE: MANDATORY COMPLETION

* **NEVER STOP EARLY:** You must process **EVERY** sub-question listed in the Marking Scheme.
* **IGNORE SCORE LIMITS DURING SCANNING:** Do not stop marking just because the student has reached the maximum total score.
    * If Q10a has [MAX: 3] but you see 5 valid reasons to tick, **RECORD THEM ALL**.
    * We (the System) will cut the excess marks later.
    * **CRITICAL:** If you fail to output an annotation for the last sub-question (e.g., 10bii), you fail the task.

---

## 2. THE LOGIC GATES (MARKING LOGIC)

### GATE A: THE "HIGHLANDER" RULE (For "OR" Lists)
* **CONTEXT:** Schemes often list alternatives like "36 or 19 or 41".
* **THE RULE:** These are usually **MUTUALLY EXCLUSIVE**. You award the mark **ONCE**.
* **CRITICAL EXCEPTION:** If the [MAX SCORE] is higher than the single mark line, combine marks (ignore Highlander).

### GATE B: THE "DOMINO" RULE (Full Marks for Right Answer)
* **THE LAW:** If the student has the correct answer worth 2+ marks (e.g. M1 + A1):
    * You **MUST** output **MULTIPLE ANNOTATIONS** for that single line of text.
    * **DO NOT** just give 1 mark and move on.

### GATE C: THE "VISUAL INTERVENTION" (THE INVISIBLE INK RULE)
* **CONTEXT:** Drawing questions (e.g., "Draw a box plot", "Shade the region") often have **NO TEXT** in the transcript.
* **THE TRIGGER:** If a sub-question exists in the Scheme but has **NO matching lines** in the `STUDENT WORK` transcript:
    1. **DO NOT** assume the student skipped it.
    2. **LOOK AT THE IMAGE:** Scan the visual region for that question.
    3. **FORCE AN ANNOTATION:** If you see a drawing, mark it using the specific "Visual Protocol" below.

---

## 3. MARKING SOVEREIGNTY & VISUAL PROTOCOLS

* **PRIMARY TARGET:** You are marking the **STUDENT WORK (STRUCTURED)** transcript.
* **ID DISCIPLINE:** The `line_id` field MUST be copied EXACTLY from the ID tags provided in the transcript.

### THE "TOO NEAT" DRAWING PROTOCOL (CRITICAL)
* **THE PROBLEM:** Student drawings (especially with rulers) can look like printed grid lines.
* **THE RULE:** Treat the printed grid as a **BLANK CANVAS**.
* **ASSUMPTION:** If you see **ANY** data representation (box plot, bar, cross, line) on the grid that matches the correct answer, **ASSUME IT IS STUDENT WORK**.
    * **DO NOT** assume the grid came "pre-filled" with the correct answer.
    * **DO NOT** fail the student because their drawing is "too perfect."

---

## 4. THE "ZERO TOLERANCE" LINKING PROTOCOL

You must populate the `linked_ocr_id` field to show where the student wrote the answer.
**You must operate in "SAFE MODE". Do not guess.**

### THE MATCHING RULE: EXACT VALUE ONLY
Compare the **Student Text** vs **OCR Block Text**.

1.  **ISOLATED INTEGERS:**
    * Student: "36" | OCR: "3" -> **REJECT** (Missing digit).
    * Student: "36" | OCR: "136" -> **REJECT** (Extra digit / Substring risk).
    * Student: "36" | OCR: "36" -> **MATCH**.
2.  **FRACTIONS/MATH:**
    * Student: "1/2" | OCR: "\frac{1}{2}" -> **MATCH** (Value is identical).
    * Student: "77/100" | OCR: "19/60" -> **REJECT** (Different numbers).

### THE OUTCOME
* **IF EXACT MATCH FOUND:**
    * Set `ocr_match_status: "MATCHED"`.
    * Set `linked_ocr_id` to the ID.
* **IF ANY DOUBT:**
    * Set `ocr_match_status: "UNMATCHED"`.
    * Set `linked_ocr_id: null`.

---

## 5. JSON STRUCTURE & CONSTRAINTS

* **Constraint A:** **NEVER** anchor a mark to a Question Label (e.g., "Q10", "(a)").
* **Constraint B (COORDINATE ECONOMY):**
    * **IF** you find a matching line of text/math OR a `[VISUAL WORKSPACE]` line:
        * You **MUST** use that `line_id`.
        * You **MUST** set `visual_position: null`. (The system knows the coordinates).
    * **IF AND ONLY IF** you are marking a drawing/graph and **NO** matching line exists:
        * You **MUST** set `line_id: null`.
        * You **MUST** provide `visual_position` in PERCENTAGES (0-100).

* **Constraint C (VISUAL STAGGERING):** [CRITICAL]
    * **NEVER** stack multiple ticks at the exact same coordinate.
    * If awarding multiple marks for one drawing (e.g., M1, M1, A1), you **MUST shift the x-position** for each one so they are distinct.
    * **Bad:** {x:50, y:30}, {x:50, y:30}, {x:50, y:30} (System will delete duplicates).
    * **Good:** {x:50, y:30}, {x:55, y:30}, {x:60, y:30}.
    * **Targeting:** Place ticks roughly in the **CENTER (x: 50)** of the drawing area, not the left margin (x: 10).

* **Constraint D (SUB-QUESTION SILO):** [CRITICAL]
    * You are strictly forbidden from linking a mark for **Sub-Question X** to a line ID belonging to **Sub-Question Y**.
    * **Example:** If marking "5c", you MUST use an ID listed under the `[SUB-QUESTION 5c]` header.
    * **Context Rule:** If "5c" relies on a graph drawn in "5b", but "5c" has its own text lines (e.g. the answer), you **MUST anchor the mark to the 5c Text Line**. Do not link back to the 5b graph.

## ðŸ’¾ JSON OUTPUT STRUCTURE (MANDATORY)

```json
{
  "meta": {
    "question_total_marks": "Integer",
    "raw_correct_steps_found": "Integer",
    "steps_dropped_to_fit_budget": "Integer",
    "isTotalEstimated": "Boolean"
  },
  "visualObservation": "String",
  "annotations": [
    {
      "action": "tick|cross", // CRITICAL: Use 'tick' IF text is awarded (e.g. M1). Use 'cross' IF text is unawarded (e.g. M0).
      "text": "String (CRITICAL: Mark Code. Use M1/A1 for awarded, M0/A0 for unawarded. e.g. M1, A0)",
      "line_id": "String (The ID of the handwriting line being marked. NULL if marking a drawing/diagram)",
      "content_desc": "String (OPTIONAL. Only use if marking a DRAWING to describe what was found, e.g. 'Box plot with median at 40'. For text, leave null.)",
      "ocr_match_status": "MATCHED|UNMATCHED|VISUAL",
      "linked_ocr_id": "String (The p0_ocr_... ID or null)",
      "reasoning": "String",
      "subQuestion": "String",
      "pageIndex": "Integer",
      "visual_position": { 
          "x": "Integer", "y": "Integer", "width": "Integer", "height": "Integer"
      }
    }
  ],
  "studentScore": {
    "totalMarks": "Integer",
    "awardedMarks": "Integer",
    "scoreText": "String"
  }
}
```

**FINAL CHECKLIST:**
1. Did I apply the Highlander Rule?
2. Did I ensure `line_id` is a Classification ID (p0_q...) OR null for visuals?
3. **VISUAL CHECK:** Did I use **PERCENTAGES (0-100)** for visual_position, NOT pixels?
4. Did I output an entry for the LAST sub-question?
------------------------------------------------------------------
USER PROMPT:
 
# MARKING TASK: Question 7

## QUESTION TEXT
**[7]**: Kasim has some small jars, some medium jars and some large jars. He has a total of 400 jars. $\frac{3}{8}$ of the 400 jars are empty. For the empty jars, number of small jars: number of medium jars = 3:4 number of medium jars: number of large jars = 1:2 Work out the percentage of Kasim's jars that are empty small jars.


## GENERAL MARKING GUIDANCE (CHIEF EXAMINER INSTRUCTION)
## GENERAL MARKING GUIDANCE
> [!IMPORTANT]
> **Precedence:** Specific notes for individual questions take precedence over this general guidance.

### General Principles
- All candidates must receive the same treatment (mark the last candidate the same way as the first).
- Mark schemes should be applied positively; all available marks are designed to be awarded.
- Examiners should be prepared to award zero marks if the response is not worthy of credit.
- Where judgement is required, mark schemes provide the principles for awards, and guidance/exemplification is not exhaustive.
- If you are in doubt about applying the mark scheme, send the response for review.





## MARKING SCHEME
> [INSTRUCTION]: You are the CHIEF EXAMINER.
> 1. **MATCH**: Match the student's work strictly to the M1/A1/B1 definitions below.
> 2. **STRICT SILO RULE (CRITICAL)**:
>    - You MUST respect the [MAX SCORE] for each sub-question.
>    - **OVERFLOW CHECK:** If you find 4 valid marks, but [6a] only allows 2, you MUST check if the other 2 marks belong to [6b].
>    - **DO NOT** lump all marks into the first bucket. Distribute them based on which sub-question they answer.

[OFFICIAL SCHEME]
[7]
- P1: for process to find the number of empty jars
- P1: for start of process to deal with ratios
- P1: for process to find the number of empty small jars
- P1: for process to find percentage
- A1: for 7.5 or $7\frac{1}{2}$ oe
- OR: 
- P1: for start of process to deal with ratios
- P1: for process to find the proportion of the empty jars that are small
- P1: for process to find the proportion of Kasim's jars that are empty small jars
- P1: for process to find percentage
- A1: for 7.5 or $7\frac{1}{2}$ oe


> [!IMPORTANT]
> The number of annotations you generate MUST BE EXACTLY EQUAL to the number of marks available in the MARKING SCHEME.
> - If the marking scheme has 4 potential marks (e.g., M1, M1, A1, B1), you MUST return exactly 4 annotations.
> - Do NOT omit marks that were not awarded; return them as 0 (e.g., M0, A0) to ensure the count matches exactly.


## STUDENT WORK (STRUCTURED)
[ID: p0_q7_line_9] 75
[ID: p0_q7_line_8] \frac{30}{400}Ã—100\%
[ID: p0_q7_line_7] = 30:40:80
[ID: p0_q7_line_6] \frac{150}{19}=10
[ID: p0_q7_line_5] 3:4:8â‡’19
[ID: p0_q7_line_4] 1:2
[ID: p0_q7_line_3] 3:4
[ID: p0_q7_line_2] S: m: L
[ID: p0_q7_line_1] 400Ã—\frac{3}{8}= 150 empty


 
## RAW OCR BLOCKS
Use these IDs to map the student's work. Match them yourself based on the Semantic Fidelity Rules.

[p0_ocr_0]: "7 Kasim has some small jars, some medium jars and some large jars."
[p0_ocr_1]: "He has a total of 400 jars. [PRINTED_INSTRUCTION]"
[p0_ocr_2]: "\( \frac{3}{8} \) of the 400 jars are empty. [PRINTED_INSTRUCTION]"
[p0_ocr_3]: "For the empty jars, [PRINTED_INSTRUCTION]"
[p0_ocr_4]: "number of small jars : number of medium jars \( =3: 4 \) [PRINTED_INSTRUCTION]"
[p0_ocr_5]: "number of medium jars: number of large jars \( =1: 2 \) [PRINTED_INSTRUCTION]"
[p0_ocr_6]: "Work out the percentage of Kasim's jars that are empty small jars. [PRINTED_INSTRUCTION]"
[p0_ocr_7]: "400 \times \frac{3}{8}=190 \text { empty }"
[p0_ocr_8]: "\text { Sim: } \mathrm{L}"
[p0_ocr_9]: "3: 4"
[p0_ocr_10]: "1: 2"
[p0_ocr_11]: "3: 4: 8 \Rightarrow 19 \quad \frac{150}{19}=10"
[p0_ocr_12]: "=30: 40: 80"
[p0_ocr_13]: "\quad \frac{30}{400} \times 1000 \%"
[p0_ocr_14]: "75 \%"
[p0_ocr_15]: "9"

--------------------------------------------------
FINAL QUALITY CHECK (DO NOT IGNORE):
1. **PARTIAL MATCH TRAP:** Did you match a number like "36" to a digit like "3"? -> STOP. Return UNMATCHED.
2. **LABEL TRAP:** Did you anchor to a label like "(a)", "(ii)", or "Q1"? -> STOP. Return UNMATCHED.
3. **MISSING DATA:** If the exact whole number is not in the list, use "UNMATCHED".
--------------------------------------------------

==================================================================


========================================
[LOG-DEBUG] Raw AI MARKING JSON Response
----------------------------------------
```json
{
  "meta": {
    "question_total_marks": 5,
    "raw_correct_steps_found": 0,
    "steps_dropped_to_fit_budget": 0,
    "isTotalEstimated": false
  },
  "visualObservation": null,
  "annotations": [
    {
      "action": "tick",
      "text": "P1",
      "line_id": "p0_q7_line_1",
      "content_desc": null,
      "ocr_match_status": "MATCHED",
      "linked_ocr_id": "p0_ocr_7",
      "reasoning": "Student calculates the number of empty jars: 400 * (3/8) = 150. This is the correct process to find the number of empty jars.",
      "subQuestion": "7",
      "pageIndex": 0,
      "visual_position": null
    },
    {
      "action": "tick",
      "text": "P1",
      "line_id": "p0_q7_line_5",
      "content_desc": null,
      "ocr_match_status": "MATCHED",
      "linked_ocr_id": "p0_ocr_11",
      "reasoning": "Student attempts to combine the ratios 3:4 and 1:2 into 3:4:8. This is the start of the process to deal with ratios.",
      "subQuestion": "7",
      "pageIndex": 0,
      "visual_position": null
    },
    {
      "action": "cross",
      "text": "P0",
      "line_id": "p0_q7_line_7",
      "content_desc": null,
      "ocr_match_status": "MATCHED",
      "linked_ocr_id": "p0_ocr_12",
      "reasoning": "The student incorrectly calculates the number of empty small jars. The ratio 3:4:8 represents small:medium:large, and the total number of empty jars is 150.  The number of small jars should be (3/15)*150 = 30.  However, the student does not correctly calculate this.",
      "subQuestion": "7",
      "pageIndex": 0,
      "visual_position": null
    },
    {
      "action": "tick",
      "text": "P1",
      "line_id": "p0_q7_line_8",
      "content_desc": null,
      "ocr_match_status": "MATCHED",
      "linked_ocr_id": "p0_ocr_13",
      "reasoning": "Student attempts to calculate the percentage of empty small jars by dividing the number of empty small jars by the total number of jars and multiplying by 100%. This is the correct process to find the percentage.",
      "subQuestion": "7",
      "pageIndex": 0,
      "visual_position": null
    },
    {
      "action": "cross",
      "text": "A0",
      "line_id": "p0_q7_line_9",
      "content_desc": null,
      "ocr_match_status": "MATCHED",
      "linked_ocr_id": "p0_ocr_14",
      "reasoning": "The student's final answer is incorrect. The correct answer is 7.5%.",
      "subQuestion": "7",
      "pageIndex": 0,
      "visual_position": null
    }
  ],
  "studentScore": {
    "totalMarks": 5,
    "awardedMarks": 3,
    "scoreText": "3/5"
  }
}
```
========================================

[1m[32mâœ… [AI MARKING][0m [1mCOMPLETED[0m in [1m6.9s[0m ([32m[1mGEMINI-2.0-FLASH[0m)
[1m[32mâœ… [MARKING][0m [1mCOMPLETED[0m in [1m6.9s[0m ([32m[1mAI-MARKING[0m)

ðŸ” [RESULT VERIFICATION] Checking what will be combined:
   ðŸ“Š Marking Results: 1 questions
   ðŸ“ Question Results: NO
   âœ… Both modes triggered: NO
ðŸ”§ [HYBRID RESOLUTION] Applying coordinate snapping to marking results...
[32mðŸ”„ [LOGICAL RE-INDEXING] Aligning logical indices with sorted physical order...[0m
[32mâœ… [LOGICAL RE-INDEXING] Re-indexed 1 questions and 1 pages.[0m
[32mâœ… [1m[FINAL PAGE ORDER][0m [32m[1] Page 9 ([37mQ7[32m)[0m
[1m[32mâœ… [OUTPUT GENERATION][0m [1mCOMPLETED[0m in [1m1.4s[0m ([32m[1mOUTPUT-GENERATION[0m)
[V2 CLEAN FIX] ðŸ—ï¸ Building UI Structure directly from 1 Engine Results...
[V2 CLEAN FIX] âœ… UI Structure ready (Strings preserved)
[1m[32mâœ… [PERFORMANCE SUMMARY AI][0m [1mCOMPLETED[0m in [1m1.0s[0m ([32m[1mGEMINI-2.0-FLASH[0m)

ðŸ“Š [ANNOTATION SUMMARY]
-----------------------------------------------------------------------------------------
| Q#       | Score | Marks Awarded           | Match Status (AI -> Final)             |
|----------|-------|-------------------------|----------------------------------------|
| [32m7       [0m | 3/5   | A0, P1, P1, P0, P1      | AI:5/5 â†’ M:5 U:0                       |
|----------|-------|-------------------------|----------------------------------------|

=== PERFORMANCE SUMMARY ===
Total Processing Time: 22.9s
Model Used: gemini-2.0-flash
----------------------------
classification                      7.8s (34%)
marking                             6.9s (30%)
ocr_processing                      3.7s (16%)
output_generation                   1.4s (6%)
performance_summary                 1.0s (5%)
question_detection                  1.0s (4%)
database_persistence                0.2s (1%)
preprocessing                       0.2s (1%)
============================


ðŸ“Š [UsageTracker] Summary:
   Model: gemini-2.0-flash
   API Requests: 4 total
   Total Tokens: 19,674 (17,812 in + 1,862 out)
   Total Cost: $0.006099
   Mathpix OCR: 1 pages â†’ $0.004000

   Breakdown by Phase:
   â€¢ Mapper (Map Pass): 4,149 tokens (1 requests) â†’ $0.000427
   â€¢ Classification (Marking Pass): 7,145 tokens (1 requests) â†’ $0.000975
   â€¢ Marking: 7,763 tokens (1 requests) â†’ $0.001046
   â€¢ Performance Summary: 617 tokens (1 requests) â†’ $0.000078


ðŸ ========== UNIFIED PIPELINE END ==========
ðŸ ==========================================

âœ… [CONTROLLER] Pipeline completed, result exists: true, sessionId: sub-1769761922066
ðŸ’³ [CREDIT DEDUCT] Starting deduction for user: 9mBfvniXTuMtQU8f0OnLhUK6aOv2, sessionId: sub-1769761922066
ðŸ’³ [CREDIT DEDUCT] Incremental cost from tracker: 0.0060988
ðŸ” [SUBJECT EXTRACTION] examPapers[0].subject = "Mathematics"
ðŸ’³ Deducted 0.61 credits from user 9mBfvniXTuMtQU8f0OnLhUK6aOv2 (session: sub-1769761922066), remaining: 329.24
ðŸ’³ Deducted 0.0061 credits (session: sub-1769761922066) from user 9mBfvniXTuMtQU8f0OnLhUK6aOv2
âœ… [SUBJECT MARKING RESULT] Persisted marking result for subject: Mathematics, session: sub-1769761922066
ðŸ‘¤ [PLAN CHECK] User 9mBfvniXTuMtQU8f0OnLhUK6aOv2 is on plan: ultra
ðŸ“¡ [MARKING] Processing POST /api/marking/process (hasRawBody: false)
ðŸš€ [MARKING] Controller started - Files: 2, Body Keys: model, aiMessageId
ðŸ” [CREDIT DEBUG] userId: 9mBfvniXTuMtQU8f0OnLhUK6aOv2, isAuthenticated: true
ðŸ’³ [CREDIT CHECK] Starting credit check for user: 9mBfvniXTuMtQU8f0OnLhUK6aOv2
ðŸ’³ [CREDIT CHECK] Estimated cost: 0.1886509, files: 2, bytes: 1786509
ðŸ’³ [CREDIT CHECK] Result: {"canProceed":true,"remaining":329.24}

ðŸ”„ ========== UNIFIED PIPELINE START ==========
ðŸ”„ ============================================

[1m[32mâœ… [INPUT VALIDATION][0m [1mCOMPLETED[0m in [1m0.0s[0m ([32m[1mVALIDATION[0m)
[INPUT TYPE] Detected: Multiple Images (2 files)
[1m[32mâœ… [PREPROCESSING][0m [1mCOMPLETED[0m in [1m0.3s[0m ([32m[1mIMAGE-PROCESSING[0m)
[MAPPER] Using model: gemini-2.0-flash
[MAPPER] Starting Map Pass for 2 pages...
âœ… [MAPPER] Map Pass complete in 1.13s. Mapped 2 pages.
[1m[32mâœ… [CLASSIFICATION][0m [1mCOMPLETED[0m in [1m7.8s[0m ([32m[1mGEMINI-2.0-FLASH[0m)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ðŸ”€ [PERFECT SPLIT] Building standalone structures with re-indexing
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ðŸŽ¯ [MODE ROUTING] Pure marking mode

âœ… Perfect split complete - each mode has consecutive 0-based indices
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

[1m[32mâœ… [CLASSIFICATION][0m [1mCOMPLETED[0m in [1m7.8s[0m ([32m[1mGEMINI-2.0-FLASH[0m)
ðŸ” [MODE DETECTION] Analysis (AFTER overrides):
  - All question-only: false
  - Has mixed content: false
  - Has any student work: true
  - Selected mode: Marking Mode
[1m[32mâœ… [OCR PROCESSING][0m [1mCOMPLETED[0m in [1m2.9s[0m ([32m[1mMATHPIX[0m)
[SIMILARITY OVERRIDE] 85% because MatchRate=0.75
[DETECTION] ðŸ† Relative Winner Accepted: 0.794 vs Runner-up 0.571
[SIMILARITY OVERRIDE] 98% because MatchRate=1.00 in Keys=[kasim,some,small,jars,medium,large,fraction,empty,number,percentage,kasims]
   âœ… Matched Part: 6a (3 marks)
   âœ… Matched Part: 6b (1 marks)
   ðŸ“Š Final Map Keys: 6a, 6b
   âœ… Matched Part: 7 (11 marks)
   ðŸ“Š Final Map Keys: 7
[1m[32mâœ… [QUESTION DETECTION][0m [1mCOMPLETED[0m in [1m0.8s[0m ([32m[1mQUESTION-DETECTION[0m)

ðŸ” [DETECTION CONTEXT]
   Strategy: Global Search
   Pool Size: 108 papers, 2709 total question candidates
------------------------------------------------------------------------------------------------------------------------------------

ðŸ“‹ [DETECTION AUDIT REPORT]
------------------------------------------------------------------------------------------------------------------------------------
| Q#   | Input Text (Fragment)                       | Match Result / Paper Title                         | Score | Status        |
------------------------------------------------------------------------------------------------------------------------------------
| 6    | Here is a straight line L drawn on a grid.    | Edexcel GCSE 1MA1/1H June 2024 Q6                  | 0.794 | [33mâš ï¸  RESCUED[0m    |
   â””â”€ Runners Up (Audit Trail):
      [32mâ—‹[0m [0.794] 1MA1/1H Q6                     | Txt:0.85 Num:0.44 Str:1.00 Sem:PASS
      â—‹ [0.571] J560/01 Q6                     | Txt:0.27 Num:0.60 Str:1.00 Sem:PASS
      â—‹ [0.561] 8300/1H Q6                     | Txt:0.14 Num:0.80 Str:1.00 Sem:PASS
| 6a   | Here is a straight line L drawn on a grid.... | Edexcel GCSE 1MA1/1H June 2024 Q6                  | 0.794 | [33mâš ï¸  RESCUED[0m    |
   â””â”€ Runners Up (Audit Trail):
      [32mâ—‹[0m [0.794] 1MA1/1H Q6                     | Txt:0.85 Num:0.44 Str:1.00 Sem:PASS
      â—‹ [0.571] J560/01 Q6                     | Txt:0.27 Num:0.60 Str:1.00 Sem:PASS
      â—‹ [0.561] 8300/1H Q6                     | Txt:0.14 Num:0.80 Str:1.00 Sem:PASS
| 6b   | Here is a straight line L drawn on a grid.... | Edexcel GCSE 1MA1/1H June 2024 Q6                  | 0.794 | [33mâš ï¸  RESCUED[0m    |
   â””â”€ Runners Up (Audit Trail):
      [32mâ—‹[0m [0.794] 1MA1/1H Q6                     | Txt:0.85 Num:0.44 Str:1.00 Sem:PASS
      â—‹ [0.571] J560/01 Q6                     | Txt:0.27 Num:0.60 Str:1.00 Sem:PASS
      â—‹ [0.561] 8300/1H Q6                     | Txt:0.14 Num:0.80 Str:1.00 Sem:PASS
| 7    | Kasim has some small jars, some medium jar... | Edexcel GCSE 1MA1/1H June 2024 Q7                  | 0.899 | [32mâœ… SUCCESS[0m      |
------------------------------------------------------------------------------------------------------------------------------------


ðŸ“Š [QUESTION DETECTION STATISTICS]
   Total questions: 4
   Detected: 4/4
   Not detected: 0
   [HINT] Hint Used: "Global Search"
   [HINT] Matched Papers: 108
ðŸ” [MERGE-DEBUG] attempting to merge classification results into 2 pages
   âœ… [MERGE-DEBUG] Page 0 merged with 1 results (Total Qs: 1)
   âœ… [MERGE-DEBUG] Page 1 merged with 1 results (Total Qs: 1)
ðŸ†” [GLOBAL-ID] Assigning stable IDs to all OCR blocks before task creation...
âœ… createMarkingTasksFromClassification completed, created 2 marking task(s)
[1m[32mðŸ”„ [AI MARKING][0m [1mSTARTING...[0m
[33m[POS-DEBUG] âš ï¸ Missing Position for Q6 -> (0,0).[0m
[33m   - ClassBlocks: 0[0m
[33m   - QuestionDetection: true[0m
   ðŸ¤– [ZONE-STRATEGY] Generic Loop. Using 1 Classification-derived zones.

ðŸš€ [PROMPT-ALIGNMENT] FINAL AI PROMPT SENT TO MODEL:
==================================================================
SYSTEM PROMPT:
 You are an AI assistant that marks student work. Your task is to generate a single, valid JSON object.

---

## 1. THE PRIME DIRECTIVE: MANDATORY COMPLETION

* **NEVER STOP EARLY:** You must process **EVERY** sub-question listed in the Marking Scheme.
* **IGNORE SCORE LIMITS DURING SCANNING:** Do not stop marking just because the student has reached the maximum total score.
    * If Q10a has [MAX: 3] but you see 5 valid reasons to tick, **RECORD THEM ALL**.
    * We (the System) will cut the excess marks later.
    * **CRITICAL:** If you fail to output an annotation for the last sub-question (e.g., 10bii), you fail the task.

---

## 2. THE LOGIC GATES (MARKING LOGIC)

### GATE A: THE "HIGHLANDER" RULE (For "OR" Lists)
* **CONTEXT:** Schemes often list alternatives like "36 or 19 or 41".
* **THE RULE:** These are usually **MUTUALLY EXCLUSIVE**. You award the mark **ONCE**.
* **CRITICAL EXCEPTION:** If the [MAX SCORE] is higher than the single mark line, combine marks (ignore Highlander).

### GATE B: THE "DOMINO" RULE (Full Marks for Right Answer)
* **THE LAW:** If the student has the correct answer worth 2+ marks (e.g. M1 + A1):
    * You **MUST** output **MULTIPLE ANNOTATIONS** for that single line of text.
    * **DO NOT** just give 1 mark and move on.

### GATE C: THE "VISUAL INTERVENTION" (THE INVISIBLE INK RULE)
* **CONTEXT:** Drawing questions (e.g., "Draw a box plot", "Shade the region") often have **NO TEXT** in the transcript.
* **THE TRIGGER:** If a sub-question exists in the Scheme but has **NO matching lines** in the `STUDENT WORK` transcript:
    1. **DO NOT** assume the student skipped it.
    2. **LOOK AT THE IMAGE:** Scan the visual region for that question.
    3. **FORCE AN ANNOTATION:** If you see a drawing, mark it using the specific "Visual Protocol" below.

---

## 3. MARKING SOVEREIGNTY & VISUAL PROTOCOLS

* **PRIMARY TARGET:** You are marking the **STUDENT WORK (STRUCTURED)** transcript.
* **ID DISCIPLINE:** The `line_id` field MUST be copied EXACTLY from the ID tags provided in the transcript.

### THE "TOO NEAT" DRAWING PROTOCOL (CRITICAL)
* **THE PROBLEM:** Student drawings (especially with rulers) can look like printed grid lines.
* **THE RULE:** Treat the printed grid as a **BLANK CANVAS**.
* **ASSUMPTION:** If you see **ANY** data representation (box plot, bar, cross, line) on the grid that matches the correct answer, **ASSUME IT IS STUDENT WORK**.
    * **DO NOT** assume the grid came "pre-filled" with the correct answer.
    * **DO NOT** fail the student because their drawing is "too perfect."

---

## 4. THE "ZERO TOLERANCE" LINKING PROTOCOL

You must populate the `linked_ocr_id` field to show where the student wrote the answer.
**You must operate in "SAFE MODE". Do not guess.**

### THE MATCHING RULE: EXACT VALUE ONLY
Compare the **Student Text** vs **OCR Block Text**.

1.  **ISOLATED INTEGERS:**
    * Student: "36" | OCR: "3" -> **REJECT** (Missing digit).
    * Student: "36" | OCR: "136" -> **REJECT** (Extra digit / Substring risk).
    * Student: "36" | OCR: "36" -> **MATCH**.
2.  **FRACTIONS/MATH:**
    * Student: "1/2" | OCR: "\frac{1}{2}" -> **MATCH** (Value is identical).
    * Student: "77/100" | OCR: "19/60" -> **REJECT** (Different numbers).

### THE OUTCOME
* **IF EXACT MATCH FOUND:**
    * Set `ocr_match_status: "MATCHED"`.
    * Set `linked_ocr_id` to the ID.
* **IF ANY DOUBT:**
    * Set `ocr_match_status: "UNMATCHED"`.
    * Set `linked_ocr_id: null`.

---

## 5. JSON STRUCTURE & CONSTRAINTS

* **Constraint A:** **NEVER** anchor a mark to a Question Label (e.g., "Q10", "(a)").
* **Constraint B (COORDINATE ECONOMY):**
    * **IF** you find a matching line of text/math OR a `[VISUAL WORKSPACE]` line:
        * You **MUST** use that `line_id`.
        * You **MUST** set `visual_position: null`. (The system knows the coordinates).
    * **IF AND ONLY IF** you are marking a drawing/graph and **NO** matching line exists:
        * You **MUST** set `line_id: null`.
        * You **MUST** provide `visual_position` in PERCENTAGES (0-100).

* **Constraint C (VISUAL STAGGERING):** [CRITICAL]
    * **NEVER** stack multiple ticks at the exact same coordinate.
    * If awarding multiple marks for one drawing (e.g., M1, M1, A1), you **MUST shift the x-position** for each one so they are distinct.
    * **Bad:** {x:50, y:30}, {x:50, y:30}, {x:50, y:30} (System will delete duplicates).
    * **Good:** {x:50, y:30}, {x:55, y:30}, {x:60, y:30}.
    * **Targeting:** Place ticks roughly in the **CENTER (x: 50)** of the drawing area, not the left margin (x: 10).

* **Constraint D (SUB-QUESTION SILO):** [CRITICAL]
    * You are strictly forbidden from linking a mark for **Sub-Question X** to a line ID belonging to **Sub-Question Y**.
    * **Example:** If marking "5c", you MUST use an ID listed under the `[SUB-QUESTION 5c]` header.
    * **Context Rule:** If "5c" relies on a graph drawn in "5b", but "5c" has its own text lines (e.g. the answer), you **MUST anchor the mark to the 5c Text Line**. Do not link back to the 5b graph.

## ðŸ’¾ JSON OUTPUT STRUCTURE (MANDATORY)

```json
{
  "meta": {
    "question_total_marks": "Integer",
    "raw_correct_steps_found": "Integer",
    "steps_dropped_to_fit_budget": "Integer",
    "isTotalEstimated": "Boolean"
  },
  "visualObservation": "String",
  "annotations": [
    {
      "action": "tick|cross", // CRITICAL: Use 'tick' IF text is awarded (e.g. M1). Use 'cross' IF text is unawarded (e.g. M0).
      "text": "String (CRITICAL: Mark Code. Use M1/A1 for awarded, M0/A0 for unawarded. e.g. M1, A0)",
      "line_id": "String (The ID of the handwriting line being marked. NULL if marking a drawing/diagram)",
      "content_desc": "String (OPTIONAL. Only use if marking a DRAWING to describe what was found, e.g. 'Box plot with median at 40'. For text, leave null.)",
      "ocr_match_status": "MATCHED|UNMATCHED|VISUAL",
      "linked_ocr_id": "String (The p0_ocr_... ID or null)",
      "reasoning": "String",
      "subQuestion": "String",
      "pageIndex": "Integer",
      "visual_position": { 
          "x": "Integer", "y": "Integer", "width": "Integer", "height": "Integer"
      }
    }
  ],
  "studentScore": {
    "totalMarks": "Integer",
    "awardedMarks": "Integer",
    "scoreText": "String"
  }
}
```

**FINAL CHECKLIST:**
1. Did I apply the Highlander Rule?
2. Did I ensure `line_id` is a Classification ID (p0_q...) OR null for visuals?
3. **VISUAL CHECK:** Did I use **PERCENTAGES (0-100)** for visual_position, NOT pixels?
4. Did I output an entry for the LAST sub-question?
------------------------------------------------------------------
USER PROMPT:
 
# MARKING TASK: Question 6

## QUESTION TEXT
**[6]**: Here is a straight line L drawn on a grid. [A coordinate grid is shown with x-axis from -4 to 4 and y-axis from -3 to 7. A straight line L passes through (-2, 0) and (0, 3).] Find an equation for L. M is a different straight line with equation $y=5x$. Write down the equation of a straight line parallel to M.

**[6a]**: Find an equation for L.

**[6b]**: M is a different straight line with equation $y=5x$. Write down the equation of a straight line parallel to M.


## GENERAL MARKING GUIDANCE (CHIEF EXAMINER INSTRUCTION)
## GENERAL MARKING GUIDANCE
> [!IMPORTANT]
> **Precedence:** Specific notes for individual questions take precedence over this general guidance.

### General Principles
- All candidates must receive the same treatment (mark the last candidate the same way as the first).
- Mark schemes should be applied positively; all available marks are designed to be awarded.
- Examiners should be prepared to award zero marks if the response is not worthy of credit.
- Where judgement is required, mark schemes provide the principles for awards, and guidance/exemplification is not exhaustive.
- If you are in doubt about applying the mark scheme, send the response for review.





## MARKING SCHEME
> [INSTRUCTION]: You are the CHIEF EXAMINER.
> 1. **MATCH**: Match the student's work strictly to the M1/A1/B1 definitions below.
> 2. **STRICT SILO RULE (CRITICAL)**:
>    - You MUST respect the [MAX SCORE] for each sub-question.
>    - **OVERFLOW CHECK:** If you find 4 valid marks, but [6a] only allows 2, you MUST check if the other 2 marks belong to [6b].
>    - **DO NOT** lump all marks into the first bucket. Distribute them based on which sub-question they answer.

[OFFICIAL SCHEME]
[6a] [MAX SCORE: 3]
- M1: for a correct method to find the gradient of the line, OR identifies 3 as the intercept in words or in a partial equation OR for $y = [\frac{3}{2}]x + c$ OR for $y - b = [\frac{3}{2}](x - a)$ where $(a,b)$ is a correct coordinate
- M1: for $y = \frac{3}{2}x + 3$, oe or for $y = m x + 3, m \ne 0$
- A1: oe

[6b] [MAX SCORE: 1]
- B1: for $y = 5x + c, c \ne 0$ oe


> [!IMPORTANT]
> The number of annotations you generate MUST BE EXACTLY EQUAL to the number of marks available in the MARKING SCHEME.
> - If the marking scheme has 4 potential marks (e.g., M1, M1, A1, B1), you MUST return exactly 4 annotations.
> - Do NOT omit marks that were not awarded; return them as 0 (e.g., M0, A0) to ensure the count matches exactly.


## STUDENT WORK (STRUCTURED)

[SUB-QUESTION a]
[ID: p0_q6_line_1] y=3/2x+3

[SUB-QUESTION b]
[ID: p0_q6_line_2] y=5x+1


 
## RAW OCR BLOCKS
Use these IDs to map the student's work. Match them yourself based on the Semantic Fidelity Rules.

[p0_ocr_0]: "6 Here is a straight line \( \mathbf{L} \) drawn on a grid."
[p0_ocr_1]: "(a) Find an equation for \( \mathbf{L} \)."
[p0_ocr_2]: "y=3 / 2 x+3"
[p0_ocr_3]: "(3)"
[p0_ocr_4]: "\( \mathbf{M} \) is a different straight line with equation \( y=5 x \)"
[p0_ocr_5]: "(b) Write down the equation of a straight line parallel to \( \mathbf{M} \). [PRINTED_INSTRUCTION]"
[p0_ocr_6]: "y=9 x+1"
[p0_ocr_7]: "(1)"
[p0_ocr_8]: "8"

--------------------------------------------------
FINAL QUALITY CHECK (DO NOT IGNORE):
1. **PARTIAL MATCH TRAP:** Did you match a number like "36" to a digit like "3"? -> STOP. Return UNMATCHED.
2. **LABEL TRAP:** Did you anchor to a label like "(a)", "(ii)", or "Q1"? -> STOP. Return UNMATCHED.
3. **MISSING DATA:** If the exact whole number is not in the list, use "UNMATCHED".
--------------------------------------------------

==================================================================


ðŸš€ [PROMPT-ALIGNMENT] FINAL AI PROMPT SENT TO MODEL:
==================================================================
SYSTEM PROMPT:
 You are an AI assistant that marks student work. Your task is to generate a single, valid JSON object.

---

## 1. THE PRIME DIRECTIVE: MANDATORY COMPLETION

* **NEVER STOP EARLY:** You must process **EVERY** sub-question listed in the Marking Scheme.
* **IGNORE SCORE LIMITS DURING SCANNING:** Do not stop marking just because the student has reached the maximum total score.
    * If Q10a has [MAX: 3] but you see 5 valid reasons to tick, **RECORD THEM ALL**.
    * We (the System) will cut the excess marks later.
    * **CRITICAL:** If you fail to output an annotation for the last sub-question (e.g., 10bii), you fail the task.

---

## 2. THE LOGIC GATES (MARKING LOGIC)

### GATE A: THE "HIGHLANDER" RULE (For "OR" Lists)
* **CONTEXT:** Schemes often list alternatives like "36 or 19 or 41".
* **THE RULE:** These are usually **MUTUALLY EXCLUSIVE**. You award the mark **ONCE**.
* **CRITICAL EXCEPTION:** If the [MAX SCORE] is higher than the single mark line, combine marks (ignore Highlander).

### GATE B: THE "DOMINO" RULE (Full Marks for Right Answer)
* **THE LAW:** If the student has the correct answer worth 2+ marks (e.g. M1 + A1):
    * You **MUST** output **MULTIPLE ANNOTATIONS** for that single line of text.
    * **DO NOT** just give 1 mark and move on.

### GATE C: THE "VISUAL INTERVENTION" (THE INVISIBLE INK RULE)
* **CONTEXT:** Drawing questions (e.g., "Draw a box plot", "Shade the region") often have **NO TEXT** in the transcript.
* **THE TRIGGER:** If a sub-question exists in the Scheme but has **NO matching lines** in the `STUDENT WORK` transcript:
    1. **DO NOT** assume the student skipped it.
    2. **LOOK AT THE IMAGE:** Scan the visual region for that question.
    3. **FORCE AN ANNOTATION:** If you see a drawing, mark it using the specific "Visual Protocol" below.

---

## 3. MARKING SOVEREIGNTY & VISUAL PROTOCOLS

* **PRIMARY TARGET:** You are marking the **STUDENT WORK (STRUCTURED)** transcript.
* **ID DISCIPLINE:** The `line_id` field MUST be copied EXACTLY from the ID tags provided in the transcript.

### THE "TOO NEAT" DRAWING PROTOCOL (CRITICAL)
* **THE PROBLEM:** Student drawings (especially with rulers) can look like printed grid lines.
* **THE RULE:** Treat the printed grid as a **BLANK CANVAS**.
* **ASSUMPTION:** If you see **ANY** data representation (box plot, bar, cross, line) on the grid that matches the correct answer, **ASSUME IT IS STUDENT WORK**.
    * **DO NOT** assume the grid came "pre-filled" with the correct answer.
    * **DO NOT** fail the student because their drawing is "too perfect."

---

## 4. THE "ZERO TOLERANCE" LINKING PROTOCOL

You must populate the `linked_ocr_id` field to show where the student wrote the answer.
**You must operate in "SAFE MODE". Do not guess.**

### THE MATCHING RULE: EXACT VALUE ONLY
Compare the **Student Text** vs **OCR Block Text**.

1.  **ISOLATED INTEGERS:**
    * Student: "36" | OCR: "3" -> **REJECT** (Missing digit).
    * Student: "36" | OCR: "136" -> **REJECT** (Extra digit / Substring risk).
    * Student: "36" | OCR: "36" -> **MATCH**.
2.  **FRACTIONS/MATH:**
    * Student: "1/2" | OCR: "\frac{1}{2}" -> **MATCH** (Value is identical).
    * Student: "77/100" | OCR: "19/60" -> **REJECT** (Different numbers).

### THE OUTCOME
* **IF EXACT MATCH FOUND:**
    * Set `ocr_match_status: "MATCHED"`.
    * Set `linked_ocr_id` to the ID.
* **IF ANY DOUBT:**
    * Set `ocr_match_status: "UNMATCHED"`.
    * Set `linked_ocr_id: null`.

---

## 5. JSON STRUCTURE & CONSTRAINTS

* **Constraint A:** **NEVER** anchor a mark to a Question Label (e.g., "Q10", "(a)").
* **Constraint B (COORDINATE ECONOMY):**
    * **IF** you find a matching line of text/math OR a `[VISUAL WORKSPACE]` line:
        * You **MUST** use that `line_id`.
        * You **MUST** set `visual_position: null`. (The system knows the coordinates).
    * **IF AND ONLY IF** you are marking a drawing/graph and **NO** matching line exists:
        * You **MUST** set `line_id: null`.
        * You **MUST** provide `visual_position` in PERCENTAGES (0-100).

* **Constraint C (VISUAL STAGGERING):** [CRITICAL]
    * **NEVER** stack multiple ticks at the exact same coordinate.
    * If awarding multiple marks for one drawing (e.g., M1, M1, A1), you **MUST shift the x-position** for each one so they are distinct.
    * **Bad:** {x:50, y:30}, {x:50, y:30}, {x:50, y:30} (System will delete duplicates).
    * **Good:** {x:50, y:30}, {x:55, y:30}, {x:60, y:30}.
    * **Targeting:** Place ticks roughly in the **CENTER (x: 50)** of the drawing area, not the left margin (x: 10).

* **Constraint D (SUB-QUESTION SILO):** [CRITICAL]
    * You are strictly forbidden from linking a mark for **Sub-Question X** to a line ID belonging to **Sub-Question Y**.
    * **Example:** If marking "5c", you MUST use an ID listed under the `[SUB-QUESTION 5c]` header.
    * **Context Rule:** If "5c" relies on a graph drawn in "5b", but "5c" has its own text lines (e.g. the answer), you **MUST anchor the mark to the 5c Text Line**. Do not link back to the 5b graph.

## ðŸ’¾ JSON OUTPUT STRUCTURE (MANDATORY)

```json
{
  "meta": {
    "question_total_marks": "Integer",
    "raw_correct_steps_found": "Integer",
    "steps_dropped_to_fit_budget": "Integer",
    "isTotalEstimated": "Boolean"
  },
  "visualObservation": "String",
  "annotations": [
    {
      "action": "tick|cross", // CRITICAL: Use 'tick' IF text is awarded (e.g. M1). Use 'cross' IF text is unawarded (e.g. M0).
      "text": "String (CRITICAL: Mark Code. Use M1/A1 for awarded, M0/A0 for unawarded. e.g. M1, A0)",
      "line_id": "String (The ID of the handwriting line being marked. NULL if marking a drawing/diagram)",
      "content_desc": "String (OPTIONAL. Only use if marking a DRAWING to describe what was found, e.g. 'Box plot with median at 40'. For text, leave null.)",
      "ocr_match_status": "MATCHED|UNMATCHED|VISUAL",
      "linked_ocr_id": "String (The p0_ocr_... ID or null)",
      "reasoning": "String",
      "subQuestion": "String",
      "pageIndex": "Integer",
      "visual_position": { 
          "x": "Integer", "y": "Integer", "width": "Integer", "height": "Integer"
      }
    }
  ],
  "studentScore": {
    "totalMarks": "Integer",
    "awardedMarks": "Integer",
    "scoreText": "String"
  }
}
```

**FINAL CHECKLIST:**
1. Did I apply the Highlander Rule?
2. Did I ensure `line_id` is a Classification ID (p0_q...) OR null for visuals?
3. **VISUAL CHECK:** Did I use **PERCENTAGES (0-100)** for visual_position, NOT pixels?
4. Did I output an entry for the LAST sub-question?
------------------------------------------------------------------
USER PROMPT:
 
# MARKING TASK: Question 7

## QUESTION TEXT
**[7]**: Kasim has some small jars, some medium jars and some large jars. He has a total of 400 jars. $\frac{3}{8}$ of the 400 jars are empty. For the empty jars, number of small jars: number of medium jars = 3:4 number of medium jars: number of large jars = 1:2 Work out the percentage of Kasim's jars that are empty small jars.


## GENERAL MARKING GUIDANCE (CHIEF EXAMINER INSTRUCTION)
## GENERAL MARKING GUIDANCE
> [!IMPORTANT]
> **Precedence:** Specific notes for individual questions take precedence over this general guidance.

### General Principles
- All candidates must receive the same treatment (mark the last candidate the same way as the first).
- Mark schemes should be applied positively; all available marks are designed to be awarded.
- Examiners should be prepared to award zero marks if the response is not worthy of credit.
- Where judgement is required, mark schemes provide the principles for awards, and guidance/exemplification is not exhaustive.
- If you are in doubt about applying the mark scheme, send the response for review.





## MARKING SCHEME
> [INSTRUCTION]: You are the CHIEF EXAMINER.
> 1. **MATCH**: Match the student's work strictly to the M1/A1/B1 definitions below.
> 2. **STRICT SILO RULE (CRITICAL)**:
>    - You MUST respect the [MAX SCORE] for each sub-question.
>    - **OVERFLOW CHECK:** If you find 4 valid marks, but [6a] only allows 2, you MUST check if the other 2 marks belong to [6b].
>    - **DO NOT** lump all marks into the first bucket. Distribute them based on which sub-question they answer.

[OFFICIAL SCHEME]
[7]
- P1: for process to find the number of empty jars
- P1: for start of process to deal with ratios
- P1: for process to find the number of empty small jars
- P1: for process to find percentage
- A1: for 7.5 or $7\frac{1}{2}$ oe
- OR: 
- P1: for start of process to deal with ratios
- P1: for process to find the proportion of the empty jars that are small
- P1: for process to find the proportion of Kasim's jars that are empty small jars
- P1: for process to find percentage
- A1: for 7.5 or $7\frac{1}{2}$ oe


> [!IMPORTANT]
> The number of annotations you generate MUST BE EXACTLY EQUAL to the number of marks available in the MARKING SCHEME.
> - If the marking scheme has 4 potential marks (e.g., M1, M1, A1, B1), you MUST return exactly 4 annotations.
> - Do NOT omit marks that were not awarded; return them as 0 (e.g., M0, A0) to ensure the count matches exactly.


## STUDENT WORK (STRUCTURED)
[ID: p1_q7_line_9] 75
[ID: p1_q7_line_8] \frac{30}{400} \times 100\%
[ID: p1_q7_line_7] = 30:40:80
[ID: p1_q7_line_6] \frac{150}{19} = 10
[ID: p1_q7_line_5] 3:4:8 \Rightarrow 19
[ID: p1_q7_line_4] 1:2
[ID: p1_q7_line_3] 3:4
[ID: p1_q7_line_2] S: m: L
[ID: p1_q7_line_1] 400\times\frac{3}{8} = 150 empty


 
## RAW OCR BLOCKS
Use these IDs to map the student's work. Match them yourself based on the Semantic Fidelity Rules.

[p1_ocr_0]: "7 Kasim has some small jars, some medium jars and some large jars."
[p1_ocr_1]: "He has a total of 400 jars. [PRINTED_INSTRUCTION]"
[p1_ocr_2]: "\( \frac{3}{8} \) of the 400 jars are empty. [PRINTED_INSTRUCTION]"
[p1_ocr_3]: "For the empty jars, [PRINTED_INSTRUCTION]"
[p1_ocr_4]: "number of small jars : number of medium jars \( =3: 4 \) [PRINTED_INSTRUCTION]"
[p1_ocr_5]: "number of medium jars: number of large jars \( =1: 2 \) [PRINTED_INSTRUCTION]"
[p1_ocr_6]: "Work out the percentage of Kasim's jars that are empty small jars. [PRINTED_INSTRUCTION]"
[p1_ocr_7]: "400 \times \frac{3}{8}=190 \text { empty }"
[p1_ocr_8]: "\text { Sim: } \mathrm{L}"
[p1_ocr_9]: "3: 4"
[p1_ocr_10]: "1: 2"
[p1_ocr_11]: "3: 4: 8 \Rightarrow 19 \quad \frac{150}{19}=10"
[p1_ocr_12]: "=30: 40: 80"
[p1_ocr_13]: "\quad \frac{30}{400} \times 1000 \%"
[p1_ocr_14]: "75 \%"
[p1_ocr_15]: "9"

--------------------------------------------------
FINAL QUALITY CHECK (DO NOT IGNORE):
1. **PARTIAL MATCH TRAP:** Did you match a number like "36" to a digit like "3"? -> STOP. Return UNMATCHED.
2. **LABEL TRAP:** Did you anchor to a label like "(a)", "(ii)", or "Q1"? -> STOP. Return UNMATCHED.
3. **MISSING DATA:** If the exact whole number is not in the list, use "UNMATCHED".
--------------------------------------------------

==================================================================


========================================
[LOG-DEBUG] Raw AI MARKING JSON Response
----------------------------------------
```json
{
  "meta": {
    "question_total_marks": 4,
    "raw_correct_steps_found": 4,
    "steps_dropped_to_fit_budget": 0,
    "isTotalEstimated": false
  },
  "visualObservation": null,
  "annotations": [
    {
      "action": "tick",
      "text": "M1",
      "line_id": "p0_q6_line_1",
      "content_desc": null,
      "ocr_match_status": "MATCHED",
      "linked_ocr_id": "p0_ocr_2",
      "reasoning": "Correct method to find the gradient of the line, OR identifies 3 as the intercept in words or in a partial equation OR for $y = [\frac{3}{2}]x + c$ OR for $y - b = [\frac{3}{2}](x - a)$ where $(a,b)$ is a correct coordinate",
      "subQuestion": "6a",
      "pageIndex": 0,
      "visual_position": null
    },
    {
      "action": "tick",
      "text": "M1",
      "line_id": "p0_q6_line_1",
      "content_desc": null,
      "ocr_match_status": "MATCHED",
      "linked_ocr_id": "p0_ocr_2",
      "reasoning": "for $y = \frac{3}{2}x + 3$, oe or for $y = m x + 3, m \ne 0$",
      "subQuestion": "6a",
      "pageIndex": 0,
      "visual_position": null
    },
    {
      "action": "tick",
      "text": "A1",
      "line_id": "p0_q6_line_1",
      "content_desc": null,
      "ocr_match_status": "MATCHED",
      "linked_ocr_id": "p0_ocr_2",
      "reasoning": "oe",
      "subQuestion": "6a",
      "pageIndex": 0,
      "visual_position": null
    },
    {
      "action": "tick",
      "text": "B1",
      "line_id": "p0_q6_line_2",
      "content_desc": null,
      "ocr_match_status": "MATCHED",
      "linked_ocr_id": "p0_ocr_6",
      "reasoning": "for $y = 5x + c, c \ne 0$ oe",
      "subQuestion": "6b",
      "pageIndex": 0,
      "visual_position": null
    }
  ],
  "studentScore": {
    "totalMarks": 4,
    "awardedMarks": 4,
    "scoreText": "4/4"
  }
}
```
========================================


========================================
[LOG-DEBUG] Raw AI MARKING JSON Response
----------------------------------------
```json
{
  "meta": {
    "question_total_marks": 5,
    "raw_correct_steps_found": 5,
    "steps_dropped_to_fit_budget": 0,
    "isTotalEstimated": false
  },
  "visualObservation": null,
  "annotations": [
    {
      "action": "tick",
      "text": "P1",
      "line_id": "p1_q7_line_1",
      "content_desc": null,
      "ocr_match_status": "MATCHED",
      "linked_ocr_id": "p1_ocr_7",
      "reasoning": "Student calculates the number of empty jars: 400 * (3/8) = 150. This is the process to find the number of empty jars.",
      "subQuestion": "7",
      "pageIndex": 0,
      "visual_position": null
    },
    {
      "action": "tick",
      "text": "P1",
      "line_id": "p1_q7_line_5",
      "content_desc": null,
      "ocr_match_status": "MATCHED",
      "linked_ocr_id": "p1_ocr_11",
      "reasoning": "Student starts to deal with ratios by combining them: 3:4:8. This is the start of the process to deal with ratios.",
      "subQuestion": "7",
      "pageIndex": 0,
      "visual_position": null
    },
    {
      "action": "tick",
      "text": "P1",
      "line_id": "p1_q7_line_7",
      "content_desc": null,
      "ocr_match_status": "MATCHED",
      "linked_ocr_id": "p1_ocr_12",
      "reasoning": "Student finds the number of empty small jars: 30. This is the process to find the number of empty small jars.",
      "subQuestion": "7",
      "pageIndex": 0,
      "visual_position": null
    },
    {
      "action": "tick",
      "text": "P1",
      "line_id": "p1_q7_line_8",
      "content_desc": null,
      "ocr_match_status": "MATCHED",
      "linked_ocr_id": "p1_ocr_13",
      "reasoning": "Student sets up the percentage calculation: (30/400) * 100%. This is the process to find the percentage.",
      "subQuestion": "7",
      "pageIndex": 0,
      "visual_position": null
    },
    {
      "action": "tick",
      "text": "A1",
      "line_id": "p1_q7_line_9",
      "content_desc": null,
      "ocr_match_status": "MATCHED",
      "linked_ocr_id": "p1_ocr_14",
      "reasoning": "Student arrives at the correct answer: 7.5%.",
      "subQuestion": "7",
      "pageIndex": 0,
      "visual_position": null
    }
  ],
  "studentScore": {
    "totalMarks": 5,
    "awardedMarks": 5,
    "scoreText": "5/5"
  }
}
```
========================================

[1m[32mâœ… [AI MARKING][0m [1mCOMPLETED[0m in [1m5.2s[0m ([32m[1mGEMINI-2.0-FLASH[0m)
[1m[32mâœ… [MARKING][0m [1mCOMPLETED[0m in [1m5.2s[0m ([32m[1mAI-MARKING[0m)

ðŸ” [RESULT VERIFICATION] Checking what will be combined:
   ðŸ“Š Marking Results: 2 questions
   ðŸ“ Question Results: NO
   âœ… Both modes triggered: NO
ðŸ”§ [HYBRID RESOLUTION] Applying coordinate snapping to marking results...
[32mðŸ”„ [LOGICAL RE-INDEXING] Aligning logical indices with sorted physical order...[0m
[32mâœ… [LOGICAL RE-INDEXING] Re-indexed 2 questions and 2 pages.[0m
[32mâœ… [1m[FINAL PAGE ORDER][0m [32m[1] Page 8 ([37mQ6a[32m) -> [2] Page 9 ([37mQ7[32m)[0m
[1m[32mâœ… [OUTPUT GENERATION][0m [1mCOMPLETED[0m in [1m1.2s[0m ([32m[1mOUTPUT-GENERATION[0m)
[V2 CLEAN FIX] ðŸ—ï¸ Building UI Structure directly from 2 Engine Results...
[V2 CLEAN FIX] âœ… UI Structure ready (Strings preserved)
[1m[32mâœ… [PERFORMANCE SUMMARY AI][0m [1mCOMPLETED[0m in [1m1.0s[0m ([32m[1mGEMINI-2.0-FLASH[0m)

ðŸ“Š [ANNOTATION SUMMARY]
-----------------------------------------------------------------------------------------
| Q#       | Score | Marks Awarded           | Match Status (AI -> Final)             |
|----------|-------|-------------------------|----------------------------------------|
| [32m6       [0m | 4/4   | A1, M1, M1, B1          | AI:4/4 â†’ M:4 U:0                       |
| [90m  a     [0m | 3     | A1, M1, M1              | AI:3/3 â†’ M:3 U:0                       |
| [90m  b     [0m | 1     | B1                      | AI:1/1 â†’ M:1 U:0                       |
|----------|-------|-------------------------|----------------------------------------|
| [32m7       [0m | 5/5   | A1, P1, P1, P1, P1      | AI:5/5 â†’ M:5 U:0                       |
|----------|-------|-------------------------|----------------------------------------|

=== PERFORMANCE SUMMARY ===
Total Processing Time: 20.0s
Model Used: gemini-2.0-flash
----------------------------
classification                      7.8s (39%)
marking                             5.2s (26%)
ocr_processing                      2.9s (15%)
output_generation                   1.2s (6%)
performance_summary                 1.0s (5%)
question_detection                  0.8s (4%)
preprocessing                       0.3s (2%)
database_persistence                0.2s (1%)
============================


ðŸ“Š [UsageTracker] Summary:
   Model: gemini-2.0-flash
   API Requests: 6 total
   Total Tokens: 30,799 (27,935 in + 2,864 out)
   Total Cost: $0.011779
   Mathpix OCR: 2 pages â†’ $0.008000

   Breakdown by Phase:
   â€¢ Mapper (Map Pass): 1,359 tokens (1 requests) â†’ $0.000160
   â€¢ Classification (Marking Pass): 13,761 tokens (2 requests) â†’ $0.001736
   â€¢ Marking: 14,946 tokens (2 requests) â†’ $0.001954
   â€¢ Performance Summary: 733 tokens (1 requests) â†’ $0.000089


ðŸ ========== UNIFIED PIPELINE END ==========
ðŸ ==========================================

âœ… [CONTROLLER] Pipeline completed, result exists: true, sessionId: sub-1769762410542
ðŸ’³ [CREDIT DEDUCT] Starting deduction for user: 9mBfvniXTuMtQU8f0OnLhUK6aOv2, sessionId: sub-1769762410542
ðŸ’³ [CREDIT DEDUCT] Incremental cost from tracker: 0.0117786
ðŸ” [SUBJECT EXTRACTION] examPapers[0].subject = "Mathematics"
ðŸ’³ Deducted 1.18 credits from user 9mBfvniXTuMtQU8f0OnLhUK6aOv2 (session: sub-1769762410542), remaining: 328.06
ðŸ’³ Deducted 0.0118 credits (session: sub-1769762410542) from user 9mBfvniXTuMtQU8f0OnLhUK6aOv2
âœ… [SUBJECT MARKING RESULT] Persisted marking result for subject: Mathematics, session: sub-1769762410542
