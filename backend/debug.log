
> ai-marking-backend@1.0.0 dev
> cross-env NODE_OPTIONS=--no-deprecation nodemon --exec tsx --tsconfig tsconfig.dev.json server.ts

âœ… Permissions configuration loaded from .env.local:
   - Analysis Plans: pro, ultra
   - Model Selection Plans: pro, ultra
âœ… Credit configuration loaded from .env.local (FAIL-FAST mode):
   - Conversion Rate: $0.01 per credit
   - Free Plan: 10 credits/month
   - Pro Plan: 200 credits/month
   - Ultra Plan: 600 credits/month
ğŸ’³ Stripe initialized in TEST mode
ğŸ“š Swagger UI available at /api-docs
ğŸ‘¤ [PLAN CHECK] User 9mBfvniXTuMtQU8f0OnLhUK6aOv2 is on plan: ultra
ğŸ“¡ [MARKING] Processing POST /api/marking/process (hasRawBody: false)
ğŸš€ [MARKING] Controller started - Files: 1, Body Keys: model, aiMessageId
ğŸ” [CREDIT DEBUG] userId: 9mBfvniXTuMtQU8f0OnLhUK6aOv2, isAuthenticated: true
ğŸ’³ [CREDIT CHECK] Starting credit check for user: 9mBfvniXTuMtQU8f0OnLhUK6aOv2
ğŸ’³ [CREDIT CHECK] Estimated cost: 0.0449631, files: 1, bytes: 399631
ğŸ’³ [CREDIT CHECK] Result: {"canProceed":true,"remaining":412.78}

ğŸ”„ ========== UNIFIED PIPELINE START ==========
ğŸ”„ ============================================

[1m[32mâœ… [INPUT VALIDATION][0m [1mCOMPLETED[0m in [1m0.0s[0m ([32m[1mVALIDATION[0m)
[INPUT TYPE] Detected: Single Image (1 files)
[1m[32mâœ… [PREPROCESSING][0m [1mCOMPLETED[0m in [1m0.4s[0m ([32m[1mIMAGE-PROCESSING[0m)
[MAPPER] Using model: gemini-2.0-flash
[MAPPER] Starting Map Pass for 1 pages...
âœ… [MAPPER] Map Pass complete in 2.12s. Mapped 1 pages.
[1m[32mâœ… [CLASSIFICATION][0m [1mCOMPLETED[0m in [1m8.1s[0m ([32m[1mGEMINI-2.0-FLASH[0m)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”€ [PERFECT SPLIT] Building standalone structures with re-indexing
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¯ [MODE ROUTING] Pure marking mode

âœ… Perfect split complete - each mode has consecutive 0-based indices
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

[1m[32mâœ… [CLASSIFICATION][0m [1mCOMPLETED[0m in [1m8.1s[0m ([32m[1mGEMINI-2.0-FLASH[0m)
ğŸ” [MODE DETECTION] Analysis (AFTER overrides):
  - All question-only: false
  - Has mixed content: false
  - Has any student work: true
  - Selected mode: Marking Mode
[1m[32mâœ… [OCR PROCESSING][0m [1mCOMPLETED[0m in [1m3.5s[0m ([32m[1mMATHPIX[0m)
[1m[32mâœ… [QUESTION DETECTION][0m [1mCOMPLETED[0m in [1m0.7s[0m ([32m[1mQUESTION-DETECTION[0m)

ğŸ” [DETECTION CONTEXT]
   Strategy: Global Search
   Pool Size: 108 papers, 2709 total question candidates
------------------------------------------------------------------------------------------------------------------------------------

ğŸ“‹ [DETECTION AUDIT REPORT]
------------------------------------------------------------------------------------------------------------------------------------
| Q#   | Input Text (Fragment)                       | Match Result / Paper Title                         | Score | Status        |
------------------------------------------------------------------------------------------------------------------------------------
| 6    | Tim has two biased coins, coin A and coin ... | Edexcel GCSE 1MA1/3H June 2024 Q6                  | 0.891 | [32mâœ… SUCCESS[0m      |
| 6a   | Tim has two biased coins, coin A and coin ... | Edexcel GCSE 1MA1/3H June 2024 Q6                  | 0.891 | [32mâœ… SUCCESS[0m      |
| 6b   | Tim has two biased coins, coin A and coin ... | Edexcel GCSE 1MA1/3H June 2024 Q6                  | 0.891 | [32mâœ… SUCCESS[0m      |
------------------------------------------------------------------------------------------------------------------------------------


ğŸ“Š [QUESTION DETECTION STATISTICS]
   Total questions: 3
   Detected: 3/3
   Not detected: 0
   [HINT] Hint Used: "Global Search"
   [HINT] Matched Papers: 108
[DRAWING] Q6: Passing image to Marking AI (Drawing Classification returned 0 for this drawing question)
[DRAWING] Q6: Will pass image to Marking AI
âœ… createMarkingTasksFromClassification completed, created 1 marking task(s)
[1m[32mğŸ”„ [AI MARKING][0m [1mSTARTING...[0m

ğŸ” [MAPPING DEBUG] Available Classification Targets for Q6:
   [0] ID: line_1 | Text: "0.4" | Handwriting: true | Box: [79,154,12,14]
   [1] ID: line_2 | Text: "0.55" | Handwriting: true | Box: [121,140,17,14]
   [2] ID: line_3 | Text: "0.45" | Handwriting: true | Box: [121,186,17,14]
   [3] ID: line_4 | Text: "0.55" | Handwriting: true | Box: [121,140,17,14]
   [4] ID: line_5 | Text: "0.45" | Handwriting: true | Box: [121,186,17,14]
   [5] ID: line_6 | Text: "0.33" | Handwriting: true | Box: [171,267,17,18]
ğŸ” [ZONE SCAN] Scanning blocks for landmarks...
   ğŸ“ Found Landmark: "a" at Page 0, Y=573
   ğŸ“ Found Landmark: "b" at Page 0, Y=2083

ğŸ” [ZONE DEBUG] Detected Semantic Zones: a, b

ğŸ” [COORD-DEBUG] Inspecting Potential Offset Sources...
   ğŸ‘‰ QuestionDetection Box: undefined
   âš ï¸ ClassificationBlocks array is empty.
   [ANCHOR-FIX] Bridging Root Question '6' to First Child Landmark 'a' at Y=573
   ğŸ” [COORD-DEBUG] Using Landmark Anchor [a] for Offset: x=351, y=573

[1m[34mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”[0m
[1m[34m[AI MARKING] Q6[0m
[1m[34mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”[0m
[1m[36m## SYSTEM PROMPT[0m
You are an AI assistant that marks student work. Your task is to generate a single, valid JSON object following all rules below. Your entire response MUST start with { and end with }, with no other text.

---

## 1. GOLDEN RULES (ABSOLUTE LAWS)

1. **ATOMICITY IS MANDATORY:**
   * **LAW:** The `text` field MUST contain **ONE** single code.
   * **ILLEGAL:** "B2 B2 B2", "M1 A1", "B2, B2".
   * **LEGAL:** "B2".
   * **PENALTY:** If you combine codes, the entire grading session is FAILED.

2. **THE "ONE-SHOT" LIST RULE:**
   * **SCENARIO:** The scheme says B2: 36 or 19 or 41.
   * **INTERPRETATION:** This is a **Single-Use** marking criteria.
   * **ACTION:** If the student writes "36, 19, 41", you award **ONE** "B2" mark.
   * **PROHIBITION:** Do NOT award B2 three times. Do NOT output "B2 B2 B2".

3. **MARGIN BLINDNESS:**
   * **RULE:** Ignore printed mark counts (e.g. [3]) in the margins. Never map annotations to them.

4. **THE "NUCLEAR" MATCHER (LOGIC VS LOCATION):**
   * **APPLICABILITY:** This rule applies to numbers, equations, and text-based mathematical logic.
   * **LOGIC SOURCE:** Use **STUDENT WORK (STRUCTURED)** (transcripts) to determine correctness.
   * **LOCATION SOURCE:** Use **RAW OCR BLOCKS** ONLY to find the matching `block_ID` (coordinates).
   * **THE RULE:** If the numbers in [STUDENT WORK] and [OCR BLOCK] match, you **MUST** use the `block_ID`.
   * **EXEMPTION (DRAWINGS):** Do NOT apply this rule to drawings, diagrams, or sketches. Drawings MUST NOT be anchored to text `block_ID`s.
   * **PENALTY:** Trusting an OCR typo over a correct classification transcript for text-based work is a **CRITICAL FAILURE**.

5. **CONTEXT ISOLATION (HARD PAGE BOUNDARY):**
   - **RULE:** You must respect physical page assignments.
   - **CONSTRAINT:** If the prompt lists sub-question '2a' as being on 'Page 1' (see assignments below or in block IDs), you are **FORBIDDEN** from mapping it to a block ID that belongs to 'Page 2'.

6. **ZERO-FEEDBACK POLICY:**
   - **SILENCE IS GOLDEN:** You are a grading engine, not a tutor. No conversational text.
   - **PURE JSON:** Your output must strictly be the JSON object.
   - **EMPTY STATE:** If you have no annotations to return, return an empty `annotations` array inside the JSON object, but never speak.

---

## 2. JSON LOGIC CONSTRAINTS (CRITICAL VALIDATION)

* **JSON FORMAT:** You MUST return a single valid JSON object.
    * **NO RAW NEWLINES:** String values MUST NOT contain raw newline characters. Use \n for line breaks.
    * **LATEX ESCAPING:** All LaTeX backslashes MUST be double-escaped (e.g., \\\\frac, \\\\times).
* **CONSTRAINT A (The "ID Whitelist"):**
    * You **MUST NOT** generate a `line_id` that is not explicitly listed in the **RAW OCR BLOCKS** section.
* **CONSTRAINT B (No Fake Matches):**
    * **IF** `ocr_match_status` is **"MATCHED"**, **THEN** `line_id` **MUST** start with **"block_"**.
* **CONSTRAINT D (Sub-Question Isolation):**
    * **NEVER** map an annotation for sub-question "a" to a `block_ID` that is listed under **[SUB-QUESTION B STUDENT WORK]**.
* **CONSTRAINT E (The "Nuclear" Matcher):**
    * **Objective:** Link [Student Line] to [OCR Block] if the **NUMBERS** match.
    * **THE SUBSTRING RULE (MANDATORY):** If student line is 2sqrt(5) and you see block Smallest \\\\frac{2\\\\sqrt{5}}{3}..., **MATCH IT**.
* **CONSTRAINT F (The Block Mandate):**
    * **MANDATORY:** For text/numeric work, you MUST find the `block_ID` that corresponds to the logic. 
    * **DRAWING EXEMPTION:** Do NOT use `block_ID` for drawings. Use `ocr_match_status: "VISUAL"`.
    * **NO LAZY FALLBACKS:** You are prohibited from using placeholder `line_x` IDs for text work unless NO physical block contains a matching numeric or textual marker.

---

---

## 4. MARKING LOGIC & FALLBACK
1. **Source Strategy:** Mark based SOLELY on the **STUDENT WORK (STRUCTURED)** content.
2. **Anchor Strategy:** Map the awarded mark to the corresponding **RAW OCR BLOCK** (`block_ID`).
3. **Multi-Mark Rule:** All annotations for a single line of work **MUST** share the same `line_id`.

---

## 5. VISUAL & INDEX PROTOCOL

* **Visual Analysis (MANDATORY):** Populate `visualObservation` with concise description.
* **CRITICAL pageIndex:** Must match absolute page number (0, 1, 2...) from labels.

---

## 6. ANNOTATION RULES

1. **One Mark Per Annotation (ABSOLUTE MANDATE):** Generate a SEPARATE object for EACH mark code.
2. **MARKING PRIORITY:** ACCURACY IS KING.
3. **Reasoning (CRITICAL):** Concisely direct, max 20 words.
4. MANDATORY ANNOTATIONS: Output at least one annotation for EVERY sub-question listed in Scheme.
    * STRICT MODE RULE: Do NOT skip Part-Q. If blank, cross (A0/M0) on answer line.

---

## 7. DRAWING & VISUAL MARKING

* For drawings, sketches, or diagrams, you **MUST** use `ocr_match_status: "VISUAL"`.
* **NO MATCHING:** Do NOT generate a `block_ID` or `line_id` for drawing marks.
* **ESTIMATION:** Manually extract the drawing's location from the PROVIDED SOURCE IMAGES and populate `visual_position` with percentage bounding box (0-100).
* **MULTI-PAGE RULE:** If a question spans multiple pages, you MUST include the 0-indexed page index 'p' in the keyword (e.g. **[POSITION: x=75, y=20, p=1]** for Page 2).
* Prepend keyword **[DRAWING]** to reasoning for visual marks.

---

## 8. SCORING RULES

**RULE: SCORE LIMITS & BUDGETING**
1. **IF [MAX SCORE] EXISTS:** You **MUST NOT** award more marks than this number for this part.

**CRITICAL RULE: THE "ONE-SHOT" CONSTRAINT**
A single bullet point represents ONE mark opportunity. Once used, it is USED.

---

## ğŸ’¾ JSON OUTPUT STRUCTURE (MANDATORY)

```json
{
  "meta": {
    "question_total_marks": "Integer",
    "raw_correct_steps_found": "Integer",
    "steps_dropped_to_fit_budget": "Integer",
    "isTotalEstimated": "Boolean"
  },
  "visualObservation": "String",
  "annotations": [
    {
      "line_id": "String",
      "action": "tick|cross",
      "text": "String",
      "student_text": "String",
      "classification_text": "String",
      "ocr_match_status": "MATCHED|UNMATCHED|VISUAL",
      "reasoning": "String",
      "subQuestion": "String",
      "pageIndex": "Integer",
      "line_index": "Integer",
      "visual_position": { "x": 0, "y": 0, "width": 0, "height": 0 }
    }
  ],
  "studentScore": {
    "totalMarks": "Integer",
    "awardedMarks": "Integer",
    "scoreText": "String"
  }
}
```

**CRITICAL REMINDER:** The "totalMarks" field MUST reflect the sum of all available marks in the scheme (Absolute Truth).
[1m[34m------------------------------------------------------------[0m

[1m[36m# MARKING TASK: Question 6

## QUESTION TEXT
**[6]**: Tim has two biased coins, coin A and coin B. He is going to throw both coins. The probability that coin A will land on heads is 0.6. The probability that coin B will land on heads is 0.55. Complete the probability tree diagram. Tim throws coin A once and he throws coin B once. Work out the probability that both coins land on heads.

**[6a]**: Tim has two biased coins, coin A and coin B. He is going to throw both coins. The probability that coin A will land on heads is 0.6. The probability that coin B will land on heads is 0.55. Complete the probability tree diagram.

**[6b]**: Tim throws coin A once and he throws coin B once. Work out the probability that both coins land on heads.


## GENERAL MARKING GUIDANCE (CHIEF EXAMINER INSTRUCTION)
## GENERAL MARKING GUIDANCE
> [!IMPORTANT]
> **Precedence:** These notes offer general guidance, but the specific notes for examiners appertaining to individual questions take precedence.

### General Principles
- All candidates must receive the same treatment. Examiners must mark the last candidate in exactly the same way as they mark the first.
- Where some judgement is required, mark schemes will provide the principles by which marks will be awarded; exemplification/indicative content will not be exhaustive.
- All the marks on the mark scheme are designed to be awarded; mark schemes should be applied positively.
- Examiners should also be prepared to award zero marks if the candidate's response is not worthy of credit according to the mark scheme.





## MARKING SCHEME
> [INSTRUCTION]: You are the CHIEF EXAMINER.
> 1. **MATCH**: Match the student's work strictly to the M1/A1/B1 definitions below.
> 2. **STRICT SILO RULE (CRITICAL)**:
>    - You MUST respect the [MAX SCORE] for each sub-question.
>    - **OVERFLOW CHECK:** If you find 4 valid marks, but [6a] only allows 2, you MUST check if the other 2 marks belong to [6b].
>    - **DO NOT** lump all marks into the first bucket. Distribute them based on which sub-question they answer.

[OFFICIAL SCHEME]
[6a] [MAX SCORE: 2]
- B1: for 0.4 in correct position
- B1: for the correct probabilities for coin B in the correct place on the branches

[6b] [MAX SCORE: 2]
- M1: for a correct method, eg $0.6 \times 0.55$ only
- A1: for 0.33 oe


> [!IMPORTANT]
> The number of annotations you generate MUST BE EXACTLY EQUAL to the number of marks available in the MARKING SCHEME.
> - If the marking scheme has 4 potential marks (e.g., M1, M1, A1, B1), you MUST return exactly 4 annotations.
> - Do NOT omit marks that were not awarded; return them as 0 (e.g., M0, A0) to ensure the count matches exactly.


## STUDENT WORK (STRUCTURED)

[SUB-QUESTION a]
1. [line_1] 0.4
2. [line_2] 0.55
3. [line_3] 0.45
4. [line_4] 0.55
5. [line_5] 0.45

[SUB-QUESTION b]
6. [line_6] 0.33


 
## RAW OCR BLOCKS
Use these IDs to map the student's work. Match them yourself based on the content.

[block_0_0]: "6 Tim has two biased coins, coin A and coin B."
[block_0_1]: "He is going to throw both coins. [PRINTED_INSTRUCTION]"
[block_0_2]: "The probability that coin A will land on heads is 0.6 [PRINTED_INSTRUCTION]"
[block_0_3]: "The probability that coin B will land on heads is 0.55 [PRINTED_INSTRUCTION]"
[block_0_4]: "(a) Complete the probability tree diagram. [PRINTED_INSTRUCTION]"
[block_0_5]: "(2)"
[block_0_6]: "Tim throws coin \( \mathbf{A} \) once and he throws coin \( \mathbf{B} \) once."
[block_0_7]: "(b) Work out the probability that both coins land on heads. [PRINTED_INSTRUCTION]"
[block_0_8]: "\( \_\_\_\_ \) [PRINTED_INSTRUCTION]"
[block_0_9]: "0.33"
[block_0_10]: "(2)"
[block_0_11]: "7"[0m
[1m[34mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”[0m

[BUDGET Q6] ğŸ¥‡ Trusting AI Total: 4 (Reason: Explicit Read)
ğŸ¤– [AI RESPONSE] [31mQ6[0m - Clean response received:
  - Annotations count: [35m2[0m
  - Student score: [32m4/4[0m
  - Usage tokens: [33m7222[0m
     [36mThe student has completed the probability tree diagram and calculated the probability of both coins landing on heads.[0m
  - Annotations:
    1. [32mtick[0m [34m[block_0_4][0m [B1 B1] [34m"0.4"[0m
      â†³ Reason: Correct probability 0.4 for coin A not landing on heads. | Correct probabilities 0.55 and 0.45 for coin B.
      â†³ OCR Match: [35m"0.4"[0m
      â†³ Classification: [35m"0.4"[0m
      â†³ Status: [32m"MATCHED"[0m
    2. [32mtick[0m [34m[block_0_7][0m [M1 A1] [34m"0.33"[0m
      â†³ Reason: Correct method for calculating the probability of both coins landing on heads. | Correct probability 0.33 for both coins landing on heads.
      â†³ OCR Match: [35m"0.33"[0m
      â†³ Classification: [35m"0.33"[0m
      â†³ Status: [32m"MATCHED"[0m
   ğŸ›¡ï¸ [REDIRECT] Intercepted link to Instruction [block_0_4]
   ğŸ›¡ï¸ [REDIRECT] Intercepted link to Instruction [block_0_7]

ğŸ¤– [G0-PROMPT] Full AI Marking Context for Q6:
   --- SYSTEM PROMPT ---
You are an AI assistant that marks student work. Your task is to generate a single, valid JSON object following all rules below. Your entire response MUST start with { and end with }, with no other text.

---

## 1. GOLDEN RULES (ABSOLUTE LAWS)

1. **ATOMICITY IS MANDATORY:**
   * **LAW:** The `text` field MUST contain **ONE** single code.
   * **ILLEGAL:** "B2 B2 B2", "M1 A1", "B2, B2".
   * **LEGAL:** "B2".
   * **PENALTY:** If you combine codes, the entire grading session is FAILED.

2. **THE "ONE-SHOT" LIST RULE:**
   * **SCENARIO:** The scheme says B2: 36 or 19 or 41.
   * **INTERPRETATION:** This is a **Single-Use** marking criteria.
   * **ACTION:** If the student writes "36, 19, 41", you award **ONE** "B2" mark.
   * **PROHIBITION:** Do NOT award B2 three times. Do NOT output "B2 B2 B2".

3. **MARGIN BLINDNESS:**
   * **RULE:** Ignore printed mark counts (e.g. [3]) in the margins. Never map annotations to them.

4. **THE "NUCLEAR" MATCHER (LOGIC VS LOCATION):**
   * **APPLICABILITY:** This rule applies to numbers, equations, and text-based mathematical logic.
   * **LOGIC SOURCE:** Use **STUDENT WORK (STRUCTURED)** (transcripts) to determine correctness.
   * **LOCATION SOURCE:** Use **RAW OCR BLOCKS** ONLY to find the matching `block_ID` (coordinates).
   * **THE RULE:** If the numbers in [STUDENT WORK] and [OCR BLOCK] match, you **MUST** use the `block_ID`.
   * **EXEMPTION (DRAWINGS):** Do NOT apply this rule to drawings, diagrams, or sketches. Drawings MUST NOT be anchored to text `block_ID`s.
   * **PENALTY:** Trusting an OCR typo over a correct classification transcript for text-based work is a **CRITICAL FAILURE**.

5. **CONTEXT ISOLATION (HARD PAGE BOUNDARY):**
   - **RULE:** You must respect physical page assignments.
   - **CONSTRAINT:** If the prompt lists sub-question '2a' as being on 'Page 1' (see assignments below or in block IDs), you are **FORBIDDEN** from mapping it to a block ID that belongs to 'Page 2'.

6. **ZERO-FEEDBACK POLICY:**
   - **SILENCE IS GOLDEN:** You are a grading engine, not a tutor. No conversational text.
   - **PURE JSON:** Your output must strictly be the JSON object.
   - **EMPTY STATE:** If you have no annotations to return, return an empty `annotations` array inside the JSON object, but never speak.

---

## 2. JSON LOGIC CONSTRAINTS (CRITICAL VALIDATION)

* **JSON FORMAT:** You MUST return a single valid JSON object.
    * **NO RAW NEWLINES:** String values MUST NOT contain raw newline characters. Use \n for line breaks.
    * **LATEX ESCAPING:** All LaTeX backslashes MUST be double-escaped (e.g., \\\\frac, \\\\times).
* **CONSTRAINT A (The "ID Whitelist"):**
    * You **MUST NOT** generate a `line_id` that is not explicitly listed in the **RAW OCR BLOCKS** section.
* **CONSTRAINT B (No Fake Matches):**
    * **IF** `ocr_match_status` is **"MATCHED"**, **THEN** `line_id` **MUST** start with **"block_"**.
* **CONSTRAINT D (Sub-Question Isolation):**
    * **NEVER** map an annotation for sub-question "a" to a `block_ID` that is listed under **[SUB-QUESTION B STUDENT WORK]**.
* **CONSTRAINT E (The "Nuclear" Matcher):**
    * **Objective:** Link [Student Line] to [OCR Block] if the **NUMBERS** match.
    * **THE SUBSTRING RULE (MANDATORY):** If student line is 2sqrt(5) and you see block Smallest \\\\frac{2\\\\sqrt{5}}{3}..., **MATCH IT**.
* **CONSTRAINT F (The Block Mandate):**
    * **MANDATORY:** For text/numeric work, you MUST find the `block_ID` that corresponds to the logic. 
    * **DRAWING EXEMPTION:** Do NOT use `block_ID` for drawings. Use `ocr_match_status: "VISUAL"`.
    * **NO LAZY FALLBACKS:** You are prohibited from using placeholder `line_x` IDs for text work unless NO physical block contains a matching numeric or textual marker.

---

---

## 4. MARKING LOGIC & FALLBACK
1. **Source Strategy:** Mark based SOLELY on the **STUDENT WORK (STRUCTURED)** content.
2. **Anchor Strategy:** Map the awarded mark to the corresponding **RAW OCR BLOCK** (`block_ID`).
3. **Multi-Mark Rule:** All annotations for a single line of work **MUST** share the same `line_id`.

---

## 5. VISUAL & INDEX PROTOCOL

* **Visual Analysis (MANDATORY):** Populate `visualObservation` with concise description.
* **CRITICAL pageIndex:** Must match absolute page number (0, 1, 2...) from labels.

---

## 6. ANNOTATION RULES

1. **One Mark Per Annotation (ABSOLUTE MANDATE):** Generate a SEPARATE object for EACH mark code.
2. **MARKING PRIORITY:** ACCURACY IS KING.
3. **Reasoning (CRITICAL):** Concisely direct, max 20 words.
4. MANDATORY ANNOTATIONS: Output at least one annotation for EVERY sub-question listed in Scheme.
    * STRICT MODE RULE: Do NOT skip Part-Q. If blank, cross (A0/M0) on answer line.

---

## 7. DRAWING & VISUAL MARKING

* For drawings, sketches, or diagrams, you **MUST** use `ocr_match_status: "VISUAL"`.
* **NO MATCHING:** Do NOT generate a `block_ID` or `line_id` for drawing marks.
* **ESTIMATION:** Manually extract the drawing's location from the PROVIDED SOURCE IMAGES and populate `visual_position` with percentage bounding box (0-100).
* **MULTI-PAGE RULE:** If a question spans multiple pages, you MUST include the 0-indexed page index 'p' in the keyword (e.g. **[POSITION: x=75, y=20, p=1]** for Page 2).
* Prepend keyword **[DRAWING]** to reasoning for visual marks.

---

## 8. SCORING RULES

**RULE: SCORE LIMITS & BUDGETING**
1. **IF [MAX SCORE] EXISTS:** You **MUST NOT** award more marks than this number for this part.

**CRITICAL RULE: THE "ONE-SHOT" CONSTRAINT**
A single bullet point represents ONE mark opportunity. Once used, it is USED.

---

## ğŸ’¾ JSON OUTPUT STRUCTURE (MANDATORY)

```json
{
  "meta": {
    "question_total_marks": "Integer",
    "raw_correct_steps_found": "Integer",
    "steps_dropped_to_fit_budget": "Integer",
    "isTotalEstimated": "Boolean"
  },
  "visualObservation": "String",
  "annotations": [
    {
      "line_id": "String",
      "action": "tick|cross",
      "text": "String",
      "student_text": "String",
      "classification_text": "String",
      "ocr_match_status": "MATCHED|UNMATCHED|VISUAL",
      "reasoning": "String",
      "subQuestion": "String",
      "pageIndex": "Integer",
      "line_index": "Integer",
      "visual_position": { "x": 0, "y": 0, "width": 0, "height": 0 }
    }
  ],
  "studentScore": {
    "totalMarks": "Integer",
    "awardedMarks": "Integer",
    "scoreText": "String"
  }
}
```

**CRITICAL REMINDER:** The "totalMarks" field MUST reflect the sum of all available marks in the scheme (Absolute Truth).
   --- USER PROMPT ---

# MARKING TASK: Question 6

## QUESTION TEXT
**[6]**: Tim has two biased coins, coin A and coin B. He is going to throw both coins. The probability that coin A will land on heads is 0.6. The probability that coin B will land on heads is 0.55. Complete the probability tree diagram. Tim throws coin A once and he throws coin B once. Work out the probability that both coins land on heads.

**[6a]**: Tim has two biased coins, coin A and coin B. He is going to throw both coins. The probability that coin A will land on heads is 0.6. The probability that coin B will land on heads is 0.55. Complete the probability tree diagram.

**[6b]**: Tim throws coin A once and he throws coin B once. Work out the probability that both coins land on heads.


## GENERAL MARKING GUIDANCE (CHIEF EXAMINER INSTRUCTION)
## GENERAL MARKING GUIDANCE
> [!IMPORTANT]
> **Precedence:** These notes offer general guidance, but the specific notes for examiners appertaining to individual questions take precedence.

### General Principles
- All candidates must receive the same treatment. Examiners must mark the last candidate in exactly the same way as they mark the first.
- Where some judgement is required, mark schemes will provide the principles by which marks will be awarded; exemplification/indicative content will not be exhaustive.
- All the marks on the mark scheme are designed to be awarded; mark schemes should be applied positively.
- Examiners should also be prepared to award zero marks if the candidate's response is not worthy of credit according to the mark scheme.





## MARKING SCHEME
> [INSTRUCTION]: You are the CHIEF EXAMINER.
> 1. **MATCH**: Match the student's work strictly to the M1/A1/B1 definitions below.
> 2. **STRICT SILO RULE (CRITICAL)**:
>    - You MUST respect the [MAX SCORE] for each sub-question.
>    - **OVERFLOW CHECK:** If you find 4 valid marks, but [6a] only allows 2, you MUST check if the other 2 marks belong to [6b].
>    - **DO NOT** lump all marks into the first bucket. Distribute them based on which sub-question they answer.

[OFFICIAL SCHEME]
[6a] [MAX SCORE: 2]
- B1: for 0.4 in correct position
- B1: for the correct probabilities for coin B in the correct place on the branches

[6b] [MAX SCORE: 2]
- M1: for a correct method, eg $0.6 \times 0.55$ only
- A1: for 0.33 oe


> [!IMPORTANT]
> The number of annotations you generate MUST BE EXACTLY EQUAL to the number of marks available in the MARKING SCHEME.
> - If the marking scheme has 4 potential marks (e.g., M1, M1, A1, B1), you MUST return exactly 4 annotations.
> - Do NOT omit marks that were not awarded; return them as 0 (e.g., M0, A0) to ensure the count matches exactly.


## STUDENT WORK (STRUCTURED)

[SUB-QUESTION a]
1. [line_1] 0.4
2. [line_2] 0.55
3. [line_3] 0.45
4. [line_4] 0.55
5. [line_5] 0.45

[SUB-QUESTION b]
6. [line_6] 0.33


 
## RAW OCR BLOCKS
Use these IDs to map the student's work. Match them yourself based on the content.

[block_0_0]: "6 Tim has two biased coins, coin A and coin B."
[block_0_1]: "He is going to throw both coins. [PRINTED_INSTRUCTION]"
[block_0_2]: "The probability that coin A will land on heads is 0.6 [PRINTED_INSTRUCTION]"
[block_0_3]: "The probability that coin B will land on heads is 0.55 [PRINTED_INSTRUCTION]"
[block_0_4]: "(a) Complete the probability tree diagram. [PRINTED_INSTRUCTION]"
[block_0_5]: "(2)"
[block_0_6]: "Tim throws coin \( \mathbf{A} \) once and he throws coin \( \mathbf{B} \) once."
[block_0_7]: "(b) Work out the probability that both coins land on heads. [PRINTED_INSTRUCTION]"
[block_0_8]: "\( \_\_\_\_ \) [PRINTED_INSTRUCTION]"
[block_0_9]: "0.33"
[block_0_10]: "(2)"
[block_0_11]: "7"

   --- END PROMPT ---


ğŸ” [ANNOTATION-AUDIT] Phase 1: ID Correction for Q6

ğŸ” [ENRICH-START] Processing Q6 | 4 annotations
   âš“ [GLOBAL-OFFSET] Applying offsets: x=351, y=573

ğŸ‘‰ [ANNO 0] "B1" (ID: ) | Status In: VISUAL
   âš ï¸ [DETECTIVE] Detected 1000-scale normalized coords (121, 140)
   âœ… [PATH: VISUAL] Converted 1000 scale to Pixels.
   âš–ï¸ [SCOPED-OFFSET] Annotation "B1" uses Landmark [a] (+351, +573)
   ğŸ—ï¸ [OFFSET] Applying Anchor (+351, +573) to base (301, 492)
      Final Coord: (652, 1065)
   ğŸ [FINAL] ID:  | Status: VISUAL | Method: VISUAL_NORM_1000_CALC

ğŸ‘‰ [ANNO 1] "B1" (ID: ) | Status In: VISUAL
   âš ï¸ [DETECTIVE] Detected 1000-scale normalized coords (121, 140)
   âœ… [PATH: VISUAL] Converted 1000 scale to Pixels.
   âš–ï¸ [SCOPED-OFFSET] Annotation "B1" uses Landmark [a] (+351, +573)
   ğŸ—ï¸ [OFFSET] Applying Anchor (+351, +573) to base (301, 492)
      Final Coord: (652, 1065)
   ğŸ [FINAL] ID:  | Status: VISUAL | Method: VISUAL_NORM_1000_CALC

ğŸ‘‰ [ANNO 2] "M1" (ID: ) | Status In: VISUAL
   â„¹ï¸ [PATH: PRECOMPUTED] Preserve pixel scale: 1787, 2439
   âš–ï¸ [SCOPED-OFFSET] Annotation "M1" uses Landmark [b] (+354, +2083)
   ğŸ›¡ï¸ [OFFSET-BYPASS] Base Y (2439) is already near/past Landmark Y (2083). Skipping Anchor.
   ğŸ [FINAL] ID:  | Status: VISUAL | Method: PX_PRECOMPUTED

ğŸ‘‰ [ANNO 3] "A1" (ID: ) | Status In: VISUAL
   â„¹ï¸ [PATH: PRECOMPUTED] Preserve pixel scale: 1787, 2439
   âš–ï¸ [SCOPED-OFFSET] Annotation "A1" uses Landmark [b] (+354, +2083)
   ğŸ›¡ï¸ [OFFSET-BYPASS] Base Y (2439) is already near/past Landmark Y (2083). Skipping Anchor.
   ğŸ [FINAL] ID:  | Status: VISUAL | Method: PX_PRECOMPUTED

ğŸ” [ANNOTATION-AUDIT] Phase 3: Spatial Sanitization for Q6
âœ… [ANNOTATION-AUDIT] Complete

[SCORE DEBUG] Q6: rawScore={"totalMarks":4,"awardedMarks":4,"scoreText":"4/4"}, parsedAwarded=4, parsedTotal=4, schemeTotal=4
[GUILLOTINE CHECK] Q6: isGeneric=false, hasAnnotations=true, hasScore=true, SchemeTotal=4, ResultTotal=4
[1m[32mâœ… [AI MARKING][0m [1mCOMPLETED[0m in [1m7.2s[0m ([32m[1mGEMINI-2.0-FLASH[0m)
[1m[32mâœ… [MARKING][0m [1mCOMPLETED[0m in [1m7.2s[0m ([32m[1mAI-MARKING[0m)

ğŸ” [RESULT VERIFICATION] Checking what will be combined:
   ğŸ“Š Marking Results: 1 questions
   ğŸ“ Question Results: NO
   âœ… Both modes triggered: NO
[TOTAL TRAP] Q6: Scheme=4, AI=4, IsDefault=false -> FINAL=4
[TOTAL TRAP] Grand Total Possible Score: 4
[32mğŸ”„ [LOGICAL RE-INDEXING] Aligning logical indices with sorted physical order...[0m
[32mâœ… [LOGICAL RE-INDEXING] Re-indexed 1 questions and 1 pages.[0m
[32mâœ… [1m[FINAL PAGE ORDER][0m [32m[1] Page 6 ([37mQ6a, Q6b[32m)[0m
[1m[32mâœ… [OUTPUT GENERATION][0m [1mCOMPLETED[0m in [1m1.7s[0m ([32m[1mOUTPUT-GENERATION[0m)
[SYNC FIX] ğŸ”„ Synchronizing UI Structure (Schema Defaults) with Engine Results (Actuals)...
[SYNC FIX] âœ… Q6: Updated Total Available Marks from undefined (Schema) -> 4 (Engine)
[SYNC FIX] ğŸ Updated Grand Total from 12 -> 4
[1m[32mâœ… [PERFORMANCE SUMMARY AI][0m [1mCOMPLETED[0m in [1m0.9s[0m ([32m[1mGEMINI-2.0-FLASH[0m)

ğŸ“Š [ANNOTATION SUMMARY]
----------------------------------------------------------------------
| Q#       | Score | Marks Awarded           | Match Status              |
|----------|-------|-------------------------|---------------------------|
| [32m6       [0m | 4/4   | B1, B1, M1, A1          | M:0 V:4 U:0 S:0           |
| [90m  a     [0m | 2     | B1, B1                  | M:0 V:2 U:0 S:0           |
| [90m  b     [0m | 2     | M1, A1                  | M:0 V:2 U:0 S:0           |
|----------|-------|-------------------------|---------------------------|

=== PERFORMANCE SUMMARY ===
Total Processing Time: 23.4s
Model Used: gemini-2.0-flash
----------------------------
classification                      8.1s (34%)
marking                             7.2s (31%)
ocr_processing                      3.5s (15%)
output_generation                   1.7s (7%)
performance_summary                 0.9s (4%)
question_detection                  0.7s (3%)
preprocessing                       0.4s (2%)
database_persistence                0.2s (1%)
============================


ğŸ“Š [UsageTracker] Summary:
   Model: gemini-2.0-flash
   API Requests: 3 total
   Total Tokens: 11,643 (10,856 in + 787 out)
   Total Cost: $0.004968
   Mathpix OCR: 1 pages â†’ $0.004000

   Breakdown by Phase:
   â€¢ Mapper (Map Pass): 4,161 tokens (1 requests) â†’ $0.000432
   â€¢ Classification (Marking Pass): 6,988 tokens (1 requests) â†’ $0.000910
   â€¢ Performance Summary: 494 tokens (1 requests) â†’ $0.000059


ğŸ ========== UNIFIED PIPELINE END ==========
ğŸ ==========================================

âœ… [CONTROLLER] Pipeline completed, result exists: true, sessionId: sub-1768935950914
ğŸ’³ [CREDIT DEDUCT] Starting deduction for user: 9mBfvniXTuMtQU8f0OnLhUK6aOv2, sessionId: sub-1768935950914
ğŸ’³ [CREDIT DEDUCT] Incremental cost from tracker: 0.0049684
ğŸ” [SUBJECT EXTRACTION] examPapers[0].subject = "Mathematics"
ğŸ’³ Deducted 0.50 credits from user 9mBfvniXTuMtQU8f0OnLhUK6aOv2 (session: sub-1768935950914), remaining: 412.28
ğŸ’³ Deducted 0.0050 credits (session: sub-1768935950914) from user 9mBfvniXTuMtQU8f0OnLhUK6aOv2
âœ… [SUBJECT MARKING RESULT] Persisted marking result for subject: Mathematics, session: sub-1768935950914
âœ… Permissions configuration loaded from .env.local:
   - Analysis Plans: pro, ultra
   - Model Selection Plans: pro, ultra
âœ… Credit configuration loaded from .env.local (FAIL-FAST mode):
   - Conversion Rate: $0.01 per credit
   - Free Plan: 10 credits/month
   - Pro Plan: 200 credits/month
   - Ultra Plan: 600 credits/month
ğŸ’³ Stripe initialized in TEST mode
ğŸ“š Swagger UI available at /api-docs
âœ… Permissions configuration loaded from .env.local:
   - Analysis Plans: pro, ultra
   - Model Selection Plans: pro, ultra
âœ… Credit configuration loaded from .env.local (FAIL-FAST mode):
   - Conversion Rate: $0.01 per credit
   - Free Plan: 10 credits/month
   - Pro Plan: 200 credits/month
   - Ultra Plan: 600 credits/month
ğŸ’³ Stripe initialized in TEST mode
ğŸ“š Swagger UI available at /api-docs
