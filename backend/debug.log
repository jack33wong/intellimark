
> ai-marking-backend@1.0.0 dev
> cross-env NODE_OPTIONS=--no-deprecation nodemon --exec tsx --tsconfig tsconfig.dev.json server.ts

âœ… Permissions configuration loaded from .env.local:
   - Analysis Plans: pro, ultra
   - Model Selection Plans: pro, ultra
âœ… Credit configuration loaded from .env.local (FAIL-FAST mode):
   - Conversion Rate: $0.01 per credit
   - Free Plan: 10 credits/month
   - Pro Plan: 200 credits/month
   - Ultra Plan: 600 credits/month
ğŸ’³ Stripe initialized in TEST mode
ğŸ“š Swagger UI available at /api-docs
ğŸ‘¤ [PLAN CHECK] User 9mBfvniXTuMtQU8f0OnLhUK6aOv2 is on plan: ultra
ğŸ“¡ [MARKING] Processing POST /api/marking/process (hasRawBody: false)
ğŸš€ [MARKING] Controller started - Files: 1, Body Keys: model, aiMessageId
ğŸ” [CREDIT DEBUG] userId: 9mBfvniXTuMtQU8f0OnLhUK6aOv2, isAuthenticated: true
ğŸ’³ [CREDIT CHECK] Starting credit check for user: 9mBfvniXTuMtQU8f0OnLhUK6aOv2
ğŸ’³ [CREDIT CHECK] Estimated cost: 0.0449631, files: 1, bytes: 399631
ğŸ’³ [CREDIT CHECK] Result: {"canProceed":true,"remaining":426.36}

ğŸ”„ ========== UNIFIED PIPELINE START ==========
ğŸ”„ ============================================

[1m[32mâœ… [INPUT VALIDATION][0m [1mCOMPLETED[0m in [1m0.0s[0m ([32m[1mVALIDATION[0m)
[INPUT TYPE] Detected: Single Image (1 files)
[1m[32mâœ… [PREPROCESSING][0m [1mCOMPLETED[0m in [1m0.4s[0m ([32m[1mIMAGE-PROCESSING[0m)
[MAPPER] Using model: gemini-2.0-flash
[MAPPER] Starting Map Pass for 1 pages...
âœ… [MAPPER] Map Pass complete in 2.45s. Mapped 1 pages.
[1m[32mâœ… [CLASSIFICATION][0m [1mCOMPLETED[0m in [1m8.1s[0m ([32m[1mGEMINI-2.0-FLASH[0m)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”€ [PERFECT SPLIT] Building standalone structures with re-indexing
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¯ [MODE ROUTING] Pure marking mode

âœ… Perfect split complete - each mode has consecutive 0-based indices
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

[1m[32mâœ… [CLASSIFICATION][0m [1mCOMPLETED[0m in [1m8.1s[0m ([32m[1mGEMINI-2.0-FLASH[0m)
ğŸ” [MODE DETECTION] Analysis (AFTER overrides):
  - All question-only: false
  - Has mixed content: false
  - Has any student work: true
  - Selected mode: Marking Mode
[1m[32mâœ… [OCR PROCESSING][0m [1mCOMPLETED[0m in [1m3.6s[0m ([32m[1mMATHPIX[0m)
[1m[32mâœ… [QUESTION DETECTION][0m [1mCOMPLETED[0m in [1m0.6s[0m ([32m[1mQUESTION-DETECTION[0m)

ğŸ” [DETECTION CONTEXT]
   Strategy: Global Search
   Pool Size: 108 papers, 2709 total question candidates
------------------------------------------------------------------------------------------------------------------------------------

ğŸ“‹ [DETECTION AUDIT REPORT]
------------------------------------------------------------------------------------------------------------------------------------
| Q#   | Input Text (Fragment)                       | Match Result / Paper Title                         | Score | Status        |
------------------------------------------------------------------------------------------------------------------------------------
| 6    | Tim has two biased coins, coin A and coin ... | Edexcel GCSE 1MA1/3H June 2024 Q6                  | 0.891 | [32mâœ… SUCCESS[0m      |
| 6a   | Tim has two biased coins, coin A and coin ... | Edexcel GCSE 1MA1/3H June 2024 Q6                  | 0.891 | [32mâœ… SUCCESS[0m      |
| 6b   | Tim has two biased coins, coin A and coin ... | Edexcel GCSE 1MA1/3H June 2024 Q6                  | 0.891 | [32mâœ… SUCCESS[0m      |
------------------------------------------------------------------------------------------------------------------------------------


ğŸ“Š [QUESTION DETECTION STATISTICS]
   Total questions: 3
   Detected: 3/3
   Not detected: 0
   [HINT] Hint Used: "Global Search"
   [HINT] Matched Papers: 108
[DRAWING] Q6: Passing image to Marking AI (Drawing Classification returned 0 for this drawing question)
[DRAWING] Q6: Will pass image to Marking AI
âœ… createMarkingTasksFromClassification completed, created 1 marking task(s)
[1m[32mğŸ”„ [AI MARKING][0m [1mSTARTING...[0m

ğŸ” [MAPPING DEBUG] Available Classification Targets for Q6:
   [0] ID: line_1 | Text: "0.4" | Handwriting: true | Box: [79,154,12,14]
   [1] ID: line_2 | Text: "0.55" | Handwriting: true | Box: [121,140,17,14]
   [2] ID: line_3 | Text: "0.45" | Handwriting: true | Box: [121,186,17,14]
   [3] ID: line_4 | Text: "0.55" | Handwriting: true | Box: [121,140,17,14]
   [4] ID: line_5 | Text: "0.45" | Handwriting: true | Box: [121,186,17,14]
   [5] ID: line_6 | Text: "0.33" | Handwriting: true | Box: [171,267,17,18]
ğŸ” [ZONE SCAN] Scanning blocks for landmarks...
   ğŸ“ Found Landmark: "a" at Page 0, Y=573
   ğŸ“ Found Landmark: "b" at Page 0, Y=2083

ğŸ” [ZONE DEBUG] Detected Semantic Zones: a, b

ğŸ” [COORD-DEBUG] Inspecting Potential Offset Sources...
   ğŸ‘‰ QuestionDetection Box: undefined
   âš ï¸ ClassificationBlocks array is empty.
   [ANCHOR-FIX] Bridging Root Question '6' to First Child Landmark 'a' at Y=573
   ğŸ” [COORD-DEBUG] Using Landmark Anchor [a] for Offset: x=351, y=573
[BUDGET Q6] ğŸ¥‡ Trusting AI Total: 4 (Reason: Explicit Read)
ğŸ¤– [AI RESPONSE] [31mQ6[0m - Clean response received:
  - Annotations count: [35m3[0m
  - Student score: [32m4/4[0m
  - Usage tokens: [33m7216[0m
     [36mThe student has completed the probability tree diagram and calculated the probability of both coins landing on heads.[0m
  - Annotations:
    1. [32mtick[0m [34m[block_0_4][0m [B1 B1] [34m"0.4"[0m
      â†³ Reason: Correct probability (0.4) for coin A not landing on heads. | Correct probabilities for coin B (0.55 and 0.45) in the correct places.
      â†³ OCR Match: [35m"0.4"[0m
      â†³ Classification: [35m"(a) Complete the probability tree diagram. [PRINTED_INSTRUCTION]"[0m
      â†³ Status: [32m"MATCHED"[0m
    2. [32mtick[0m [34m[block_0_7][0m [M1] [34m"0.33"[0m
      â†³ Reason: Correct method implied by the correct answer.
      â†³ OCR Match: [35m"0.33"[0m
      â†³ Classification: [35m"(b) Work out the probability that both coins land on heads. [PRINTED_INSTRUCTION]"[0m
      â†³ Status: [32m"MATCHED"[0m
    3. [32mtick[0m [34m[block_0_9][0m [A1] [34m"0.33"[0m
      â†³ Reason: Correct answer (0.33).
      â†³ OCR Match: [35m"0.33"[0m
      â†³ Classification: [35m"0.33"[0m
      â†³ Status: [32m"MATCHED"[0m
   ğŸ›¡ï¸ [REDIRECT] Intercepted link to Instruction [block_0_4]
   ğŸ›¡ï¸ [REDIRECT] Intercepted link to Instruction [block_0_7]

ğŸ” [ANNOTATION-AUDIT] Phase 1: ID Correction for Q6

ğŸ” [ENRICH-START] Processing Q6 | 4 annotations
   âš“ [GLOBAL-OFFSET] Applying offsets: x=351, y=573

ğŸ‘‰ [ANNO 0] "B1" (ID: ) | Status In: VISUAL
   â„¹ï¸ [PATH: PRECOMPUTED] Preserve pixel scale: 121, 140
   âš–ï¸ [SCOPED-OFFSET] Annotation "B1" uses Landmark [a] (+351, +573)
   ğŸ—ï¸ [OFFSET] Applying Anchor (+351, +573)
      Final Coord: (472, 713)

ğŸ‘‰ [ANNO 1] "B1" (ID: ) | Status In: VISUAL
   â„¹ï¸ [PATH: PRECOMPUTED] Preserve pixel scale: 121, 140
   âš–ï¸ [SCOPED-OFFSET] Annotation "B1" uses Landmark [a] (+351, +573)
   ğŸ—ï¸ [OFFSET] Applying Anchor (+351, +573)
      Final Coord: (472, 713)

ğŸ‘‰ [ANNO 2] "M1" (ID: ) | Status In: VISUAL
   â„¹ï¸ [PATH: PRECOMPUTED] Preserve pixel scale: 1787, 2439
   âš–ï¸ [SCOPED-OFFSET] Annotation "M1" uses Landmark [b] (+354, +2083)
   ğŸ—ï¸ [OFFSET] Applying Anchor (+354, +2083)
      Final Coord: (2141, 4522)

ğŸ‘‰ [ANNO 3] "A1" (ID: block_0_9) | Status In: MATCHED
   âœ… [PATH: OCR] Found Mathpix Block. Passing coords INTACT.
      Input:  [1858,2447,195,110]
      Output: [1858,2447,195,110]

ğŸ” [ANNOTATION-AUDIT] Phase 3: Spatial Sanitization for Q6
âœ… [ANNOTATION-AUDIT] Complete

[SCORE DEBUG] Q6: rawScore={"totalMarks":4,"awardedMarks":4,"scoreText":"4/4"}, parsedAwarded=4, parsedTotal=4, schemeTotal=4
[GUILLOTINE CHECK] Q6: isGeneric=false, hasAnnotations=true, hasScore=true, SchemeTotal=4, ResultTotal=4
[1m[32mâœ… [AI MARKING][0m [1mCOMPLETED[0m in [1m7.4s[0m ([32m[1mGEMINI-2.0-FLASH[0m)
[1m[32mâœ… [MARKING][0m [1mCOMPLETED[0m in [1m7.4s[0m ([32m[1mAI-MARKING[0m)

ğŸ” [RESULT VERIFICATION] Checking what will be combined:
   ğŸ“Š Marking Results: 1 questions
   ğŸ“ Question Results: NO
   âœ… Both modes triggered: NO
[TOTAL TRAP] Q6: Scheme=4, AI=4, IsDefault=false -> FINAL=4
[TOTAL TRAP] Grand Total Possible Score: 4
[32mğŸ”„ [LOGICAL RE-INDEXING] Aligning logical indices with sorted physical order...[0m
[32mâœ… [LOGICAL RE-INDEXING] Re-indexed 1 questions and 1 pages.[0m
[32mâœ… [1m[FINAL PAGE ORDER][0m [32m[1] Page 6 ([37mQ6a, Q6b[32m)[0m
[1m[32mâœ… [OUTPUT GENERATION][0m [1mCOMPLETED[0m in [1m1.7s[0m ([32m[1mOUTPUT-GENERATION[0m)
[SYNC FIX] ğŸ”„ Synchronizing UI Structure (Schema Defaults) with Engine Results (Actuals)...
[SYNC FIX] âœ… Q6: Updated Total Available Marks from undefined (Schema) -> 4 (Engine)
[SYNC FIX] ğŸ Updated Grand Total from 12 -> 4
[1m[32mâœ… [PERFORMANCE SUMMARY AI][0m [1mCOMPLETED[0m in [1m0.6s[0m ([32m[1mGEMINI-2.0-FLASH[0m)

ğŸ“Š [ANNOTATION SUMMARY]
----------------------------------------------------------------------
| Q#       | Score | Marks Awarded           | Match Status              |
|----------|-------|-------------------------|---------------------------|
| [32m6       [0m | 4/4   | B1, B1, M1, A1          | M:1 V:3 U:0 S:0           |
| [90m  a     [0m | 2     | B1, B1                  | M:0 V:2 U:0 S:0           |
| [90m  b     [0m | 2     | M1, A1                  | M:1 V:1 U:0 S:0           |
|----------|-------|-------------------------|---------------------------|

=== PERFORMANCE SUMMARY ===
Total Processing Time: 23.7s
Model Used: gemini-2.0-flash
----------------------------
classification                      8.1s (34%)
marking                             7.4s (31%)
ocr_processing                      3.6s (15%)
output_generation                   1.7s (7%)
performance_summary                 0.6s (3%)
question_detection                  0.6s (3%)
preprocessing                       0.4s (2%)
database_persistence                0.3s (1%)
============================


ğŸ“Š [UsageTracker] Summary:
   Model: gemini-2.0-flash
   API Requests: 3 total
   Total Tokens: 11,615 (10,828 in + 787 out)
   Total Cost: $0.004966
   Mathpix OCR: 1 pages â†’ $0.004000

   Breakdown by Phase:
   â€¢ Mapper (Map Pass): 4,161 tokens (1 requests) â†’ $0.000432
   â€¢ Classification (Marking Pass): 6,988 tokens (1 requests) â†’ $0.000910
   â€¢ Performance Summary: 466 tokens (1 requests) â†’ $0.000056


ğŸ ========== UNIFIED PIPELINE END ==========
ğŸ ==========================================

âœ… [CONTROLLER] Pipeline completed, result exists: true, sessionId: sub-1768928042670
ğŸ’³ [CREDIT DEDUCT] Starting deduction for user: 9mBfvniXTuMtQU8f0OnLhUK6aOv2, sessionId: sub-1768928042670
ğŸ’³ [CREDIT DEDUCT] Incremental cost from tracker: 0.004965600000000001
ğŸ” [SUBJECT EXTRACTION] examPapers[0].subject = "Mathematics"
ğŸ’³ Deducted 0.50 credits from user 9mBfvniXTuMtQU8f0OnLhUK6aOv2 (session: sub-1768928042670), remaining: 425.86
ğŸ’³ Deducted 0.0050 credits (session: sub-1768928042670) from user 9mBfvniXTuMtQU8f0OnLhUK6aOv2
âœ… [SUBJECT MARKING RESULT] Persisted marking result for subject: Mathematics, session: sub-1768928042670
ğŸ’³ Deducted 0.02 credits from user 9mBfvniXTuMtQU8f0OnLhUK6aOv2 (session: sub-1768928042670), remaining: 425.84
ğŸ’³ Deducted 0.00 cost (session: sub-1768928042670, incremental) from user 9mBfvniXTuMtQU8f0OnLhUK6aOv2
âœ… Permissions configuration loaded from .env.local:
   - Analysis Plans: pro, ultra
   - Model Selection Plans: pro, ultra
âœ… Credit configuration loaded from .env.local (FAIL-FAST mode):
   - Conversion Rate: $0.01 per credit
   - Free Plan: 10 credits/month
   - Pro Plan: 200 credits/month
   - Ultra Plan: 600 credits/month
ğŸ’³ Stripe initialized in TEST mode
ğŸ“š Swagger UI available at /api-docs
âœ… Permissions configuration loaded from .env.local:
   - Analysis Plans: pro, ultra
   - Model Selection Plans: pro, ultra
âœ… Credit configuration loaded from .env.local (FAIL-FAST mode):
   - Conversion Rate: $0.01 per credit
   - Free Plan: 10 credits/month
   - Pro Plan: 200 credits/month
   - Ultra Plan: 600 credits/month
ğŸ’³ Stripe initialized in TEST mode
ğŸ“š Swagger UI available at /api-docs
âœ… Permissions configuration loaded from .env.local:
   - Analysis Plans: pro, ultra
   - Model Selection Plans: pro, ultra
âœ… Credit configuration loaded from .env.local (FAIL-FAST mode):
   - Conversion Rate: $0.01 per credit
   - Free Plan: 10 credits/month
   - Pro Plan: 200 credits/month
   - Ultra Plan: 600 credits/month
ğŸ’³ Stripe initialized in TEST mode
ğŸ“š Swagger UI available at /api-docs
âœ… Permissions configuration loaded from .env.local:
   - Analysis Plans: pro, ultra
   - Model Selection Plans: pro, ultra
âœ… Credit configuration loaded from .env.local (FAIL-FAST mode):
   - Conversion Rate: $0.01 per credit
   - Free Plan: 10 credits/month
   - Pro Plan: 200 credits/month
   - Ultra Plan: 600 credits/month
ğŸ’³ Stripe initialized in TEST mode
ğŸ“š Swagger UI available at /api-docs
